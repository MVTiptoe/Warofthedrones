import{b as e,j as t,u as s,C as o}from"./fiber-Df7GEbeL.js";import{a as r,P as i,ah as n,ai as a,aj as c,l,I as d,ak as h,al as u,am as m,an as p,ao as x,V as f,ap as y,p as g,a4 as j,aq as M,ar as w,b,k as v,C as S,ag as k,as as I,at as E,au as D}from"./vendor-I9-Q_5Qr.js";import{T as R,u as G,E as A,S as T,K as z,a as P}from"./drei-CRZIQ5AU.js";import{c as C}from"./utils-B6tTjOLc.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const F=2e3,N=205,_=Math.ceil(10),O=Math.floor(200/_);function L(){const s=r.useMemo((()=>new i(N,N,O,O)),[]),o=r.useMemo((()=>new n({color:"#4d7f38",roughness:.8,metalness:.1,flatShading:!1})),[]),c=r.useRef(),l=r.useMemo((()=>new a),[]),d=r.useMemo((()=>{const e=[];for(let t=0;t<_;t++)for(let s=0;s<_;s++)e.push({position:[200*t-1e3+100,0,200*s-1e3+100],rotation:[-Math.PI/2,0,0]});return e}),[]);return e((()=>{if(c.current)return d.forEach(((e,t)=>{const[s,o,r]=e.position,[i,n,a]=e.rotation;l.position.set(s,o,r),l.rotation.set(i,n,a),l.updateMatrix(),c.current.setMatrixAt(t,l.matrix)})),c.current.instanceMatrix.needsUpdate=!0,null}),[]),t.jsx(t.Fragment,{children:t.jsx("instancedMesh",{ref:c,args:[s,o,d.length]})})}const H=80,$=.75;function V(){const e=r.useMemo((()=>new i(F,H,1,1)),[]),s=r.useMemo((()=>new i(F,8,1,1)),[]),o=r.useMemo((()=>new n({color:"#333333",roughness:.7,metalness:.1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:1})),[]),a=r.useMemo((()=>new n({color:"#FFCC00",roughness:.5,metalness:.1,polygonOffset:!0,polygonOffsetFactor:-2,polygonOffsetUnits:1})),[]),c=r.useMemo((()=>new n({color:"#FFFFFF",roughness:.5,metalness:.1,polygonOffset:!0,polygonOffsetFactor:-2,polygonOffsetUnits:1})),[]),l=r.useMemo((()=>new n({color:"#8B5A2B",roughness:.85,metalness:.02,polygonOffset:!0,polygonOffsetFactor:-1.5,polygonOffsetUnits:1})),[]),d=r.useMemo((()=>{const e=[],t=Math.floor(250);for(let s=0;s<t;s++){const t=8*s-1e3+1.5;e.push({position:t})}return e}),[]),h=({zPosition:r})=>t.jsxs("group",{position:[0,.2,r],children:[t.jsx("mesh",{geometry:e,material:o,rotation:[-Math.PI/2,0,0]}),t.jsxs("mesh",{position:[0,0,-44],rotation:[-Math.PI/2,0,0],children:[t.jsx("primitive",{object:s}),t.jsx("primitive",{object:o})]}),t.jsxs("mesh",{position:[0,0,44],rotation:[-Math.PI/2,0,0],children:[t.jsx("primitive",{object:s}),t.jsx("primitive",{object:o})]}),t.jsxs("mesh",{position:[0,.01,-52.5],rotation:[-Math.PI/2,0,0],children:[t.jsx("planeGeometry",{args:[F,9]}),t.jsx("primitive",{object:l})]}),t.jsxs("mesh",{position:[0,.01,52.5],rotation:[-Math.PI/2,0,0],children:[t.jsx("planeGeometry",{args:[F,9]}),t.jsx("primitive",{object:l})]}),t.jsxs("mesh",{position:[0,.02,0],rotation:[-Math.PI/2,0,0],children:[t.jsx("planeGeometry",{args:[F,$]}),t.jsx("primitive",{object:a})]}),t.jsxs("mesh",{position:[0,.02,-39.5],rotation:[-Math.PI/2,0,0],children:[t.jsx("planeGeometry",{args:[F,$]}),t.jsx("primitive",{object:c})]}),t.jsxs("mesh",{position:[0,.02,39.5],rotation:[-Math.PI/2,0,0],children:[t.jsx("planeGeometry",{args:[F,$]}),t.jsx("primitive",{object:c})]}),d.map(((e,s)=>t.jsxs("mesh",{position:[e.position,.02,-20],rotation:[-Math.PI/2,0,0],children:[t.jsx("planeGeometry",{args:[3,$]}),t.jsx("primitive",{object:c})]},`left-outer-${s}`))),d.map(((e,s)=>t.jsxs("mesh",{position:[e.position,.02,20],rotation:[-Math.PI/2,0,0],children:[t.jsx("planeGeometry",{args:[3,$]}),t.jsx("primitive",{object:c})]},`right-outer-${s}`)))]});return t.jsxs(t.Fragment,{children:[t.jsx(h,{zPosition:150}),t.jsx(h,{zPosition:-150})]})}const B={PINE:"pine",OAK:"oak",PALM:"palm",BIRCH:"birch"};class U{constructor(e,t){this.bounds=e,this.dimensions=t,this.cells={}}getCell(e){const{min:t,max:s}=this.bounds;return{x:Math.floor((e.x-t.x)/(s.x-t.x)*this.dimensions.x),z:Math.floor((e.z-t.z)/(s.z-t.z)*this.dimensions.z)}}getCellKey(e){return`${e.x},${e.z}`}insert(e,t){const s=this.getCell(e),o=this.getCellKey(s);this.cells[o]||(this.cells[o]=[]),this.cells[o].push({position:e,object:t})}query(e,t){const s=[],o=this.getCell(e),r=Math.ceil(t/Math.min((this.bounds.max.x-this.bounds.min.x)/this.dimensions.x,(this.bounds.max.z-this.bounds.min.z)/this.dimensions.z));for(let i=-r;i<=r;i++)for(let n=-r;n<=r;n++){const r={x:o.x+i,z:o.z+n},a=this.getCellKey(r);if(this.cells[a])for(const o of this.cells[a]){const r=o.position.x-e.x,i=o.position.z-e.z;Math.sqrt(r*r+i*i)<=t&&s.push(o.object)}}return s}}function K(e){const t=1e4*Math.sin(e);return t-Math.floor(t)}function Y(){const{camera:o}=s(),i={pine:{trunk:r.useRef(),foliage:r.useRef()},oak:{trunk:r.useRef(),foliage:r.useRef()},palm:{trunk:r.useRef(),foliage:r.useRef()},birch:{trunk:r.useRef(),foliage:r.useRef()}},y=r.useRef(),g=r.useRef(),j=r.useRef();r.useMemo((()=>new c),[]),r.useMemo((()=>new l),[]);const M=r.useMemo((()=>new a),[]),{trees:w,rocks:b,bushes:v,largeBush:S}=r.useMemo((()=>function(e){const t=1e3,s=new U({min:{x:-1e3,z:-1e3},max:{x:t,z:t}},{x:20,z:20}),o=(e,t)=>Math.abs(t-150)<70||Math.abs(t+150)<70,r={pine:[],oak:[],palm:[],birch:[]},i=[],n=[],a=(e,t,r)=>{if(o(0,t))return!1;if(Math.abs(t-150)<80||Math.abs(t+150)<80)return!1;const i={x:e,z:t};return 0===s.query(i,r).length},c=(o,c,l,d,h)=>{for(let u=0;u<d;u++){const o=e+l+u,d=K(1.1*o),m=K(2.3*o),p=K(3.7*o),x=K(4.5*o),y=Math.floor(4*K(5.9*o)),g=d*F-t,j=m*F-t;if(!a(g,j,h))continue;const M=1.2+p*(1.8-1.2),w=x*Math.PI*2;new f(g,0,j);const b={position:[g,0,j],scale:M,rotation:w,type:y};if("tree"===c){const e=Object.values(B)[y];r[e].push(b)}else"rock"===c?i.push(b):"bush"===c&&n.push(b);s.insert({x:g,z:j},b)}};c(0,"tree",0,700,12),c(0,"rock",1e4,200,4),c(0,"bush",2e4,400,4);const l=9876*e,d=K(l)*F-t,h=K(l+100)*F-t;let u=null;return o(0,h)||(u={position:[d,0,h],scale:4,rotation:K(l+200)*Math.PI*2}),{trees:r,rocks:i,bushes:n,largeBush:u}}(12345)),[]),k=r.useMemo((()=>({pine:{trunk:new n({color:"#8B4513",roughness:.8,flatShading:!0}),foliage:new n({color:"#2E8B57",roughness:.7,flatShading:!0})},oak:{trunk:new n({color:"#654321",roughness:.9,flatShading:!0}),foliage:new n({color:"#228B22",roughness:.6,flatShading:!0})},palm:{trunk:new n({color:"#A0522D",roughness:.7,flatShading:!0}),foliage:new n({color:"#32CD32",roughness:.8,flatShading:!0})},birch:{trunk:new n({color:"#F5F5DC",roughness:.6,flatShading:!0}),foliage:new n({color:"#ADFF2F",roughness:.7,flatShading:!0})}})),[]),I=r.useMemo((()=>new n({color:"#7D7D7D",roughness:1,flatShading:!0})),[]),E=r.useMemo((()=>new n({color:"#3A5F0B",roughness:.7,flatShading:!0})),[]),D=r.useMemo((()=>new d(1,0)),[]),R=r.useMemo((()=>new h(2,6,4)),[]),G=r.useMemo((()=>({pine:{trunkHeight:4.8,trunkRadius:.75,foliageOffset:4.8},oak:{trunkHeight:4.5,trunkRadius:.975,foliageOffset:3},palm:{trunkHeight:7.5,trunkRadius:.525,foliageOffset:7.5},birch:{trunkHeight:6.75,trunkRadius:.4875,foliageOffset:4.5}})),[]),A=r.useMemo((()=>({highDetail:{pine:{trunk:new m(.6,.75,4.8,8,3),foliage:new x(3,9.6,8,4)},oak:{trunk:new m(.9,1.05,4.5,10,4),foliage:new h(3.75,12,10)},palm:{trunk:new m(.45,.6,7.5,8,5),foliage:new p(3.75,1)},birch:{trunk:new m(.45,.53,6.75,9,4),foliage:new u(3,2)}},lowDetail:{pine:{trunk:new m(.6,.75,4.8,4,1),foliage:new x(3,9.6,5,1)},oak:{trunk:new m(.9,1.05,4.5,6,1),foliage:new h(3.75,6,4)},palm:{trunk:new m(.45,.6,7.5,4,1),foliage:new p(3.75,0)},birch:{trunk:new m(.45,.53,6.75,5,1),foliage:new u(3,0)}}})),[]);return r.useEffect((()=>{if(Object.entries(w).forEach((([e,t])=>{if(!t.length)return;const{trunkHeight:s,trunkRadius:o,foliageOffset:r}=G[e],n=i[e].trunk;n.current&&t.length>0&&(t.forEach(((e,t)=>{const[o,r,i]=e.position,a=e.scale,c=s*a/2;M.position.set(o,c,i),M.rotation.set(0,e.rotation,0),M.scale.set(a,a,a),M.updateMatrix(),n.current.setMatrixAt(t,M.matrix)})),n.current.instanceMatrix.needsUpdate=!0,n.current.computeBoundingSphere(),n.current.boundingSphere&&(n.current.boundingSphere.radius*=1.5));const a=i[e].foliage;a.current&&t.length>0&&(t.forEach(((t,s)=>{const[o,i,n]=t.position,c=t.scale,l=r*c;let d;switch(e){case"pine":d=l+4.8*c;break;case"birch":d=l+2.25*c;break;default:d=l+1.5*c}M.position.set(o,d,n),M.rotation.set(0,t.rotation,0),M.scale.setScalar(c),M.updateMatrix(),a.current.setMatrixAt(s,M.matrix)})),a.current.instanceMatrix.needsUpdate=!0,a.current.computeBoundingSphere(),a.current.boundingSphere&&(a.current.boundingSphere.radius*=1.5))})),y.current&&b.length>0&&(b.forEach(((e,t)=>{const[s,o,r]=e.position,i=e.scale,n=.5*i;M.position.set(s,n,r),M.rotation.set(0,e.rotation,0),M.scale.setScalar(i),M.updateMatrix(),y.current.setMatrixAt(t,M.matrix)})),y.current.instanceMatrix.needsUpdate=!0,y.current.computeBoundingSphere(),y.current.boundingSphere&&(y.current.boundingSphere.radius*=1.5)),g.current&&v.length>0&&(v.forEach(((e,t)=>{const[s,o,r]=e.position,i=e.scale,n=2*i*.5;M.position.set(s,n,r),M.rotation.set(0,e.rotation,0),M.scale.setScalar(i),M.updateMatrix(),g.current.setMatrixAt(t,M.matrix)})),g.current.instanceMatrix.needsUpdate=!0,g.current.computeBoundingSphere(),g.current.boundingSphere&&(g.current.boundingSphere.radius*=1.5)),j.current&&S){const[e,t,s]=S.position,o=S.scale,r=2*o*.5;M.position.set(e,r,s),M.rotation.set(0,S.rotation,0),M.scale.setScalar(o),M.updateMatrix(),j.current.matrix.copy(M.matrix),j.current.matrixAutoUpdate=!1,j.current.computeBoundingSphere()}}),[w,b,v,S,G,M]),e((({camera:e})=>{const t=e.position,s=1e3;if(Object.entries(i).forEach((([e,o])=>{if(!(o.trunk.current&&o.trunk.current.boundingSphere&&o.foliage.current&&o.foliage.current.boundingSphere))return;const r=o.trunk.current.boundingSphere.center.distanceTo(t),i=o.foliage.current.boundingSphere.center.distanceTo(t);o.trunk.current.visible=r<s,o.foliage.current.visible=i<s,o.trunk.current.visible})),y.current&&y.current.boundingSphere){const e=y.current.boundingSphere.center.distanceTo(t);y.current.visible=e<s}if(g.current&&g.current.boundingSphere){const e=g.current.boundingSphere.center.distanceTo(t);g.current.visible=e<s}if(j.current&&j.current.boundingSphere){const e=j.current.boundingSphere.center.distanceTo(t);j.current.visible=e<s}})),t.jsxs("group",{children:[Object.entries(w).map((([e,s])=>{if(!s.length)return null;const o=A.highDetail[e];A.lowDetail[e];const r=k[e];return t.jsxs("group",{children:[t.jsxs("instancedMesh",{ref:i[e].trunk,args:[null,null,s.length],frustumCulled:!0,children:[t.jsx("primitive",{object:o.trunk}),t.jsx("primitive",{object:r.trunk})]}),t.jsxs("instancedMesh",{ref:i[e].foliage,args:[null,null,s.length],frustumCulled:!0,children:[t.jsx("primitive",{object:o.foliage}),t.jsx("primitive",{object:r.foliage})]})]},e)})),t.jsx("instancedMesh",{ref:y,args:[D,I,b.length],frustumCulled:!0}),t.jsx("instancedMesh",{ref:g,args:[R,E,v.length],frustumCulled:!0}),S&&t.jsxs("mesh",{ref:j,frustumCulled:!0,children:[t.jsx("sphereGeometry",{args:[2,10,8]}),t.jsx("meshStandardMaterial",{color:"#2D5B0A",roughness:.6,metalness:.1,flatShading:!0})]})]})}const X="GRENADIER",q="KAMIKAZE",Z="BOMBER",W=r.createContext();function Q({children:e}){const[s,o]=r.useState(X),i={currentDrone:s,switchDrone:e=>{o(e)}};return t.jsx(W.Provider,{value:i,children:e})}function J(){const e=r.useContext(W);if(void 0===e)throw new Error("useDrones must be used within a DronesProvider");return e}const ee={TANK:{maxHealth:100,criticalThreshold:.5,visualDamageStages:[],hitboxSize:new f(2.4,1,3.2),hitLocations:{turret:{damageMultiplier:1.2},tracks:{damageMultiplier:.8,mobilityEffect:.5},rear:{damageMultiplier:1.5},front:{damageMultiplier:.6},body:{damageMultiplier:1}}},IFV:{maxHealth:70,criticalThreshold:.5,visualDamageStages:[],hitboxSize:new f(2,.9,3),hitLocations:{turret:{damageMultiplier:1.2},wheels:{damageMultiplier:.8,mobilityEffect:.4},rear:{damageMultiplier:1.3},front:{damageMultiplier:.7},body:{damageMultiplier:1}}},MILITARY_TRUCK:{maxHealth:50,criticalThreshold:.5,visualDamageStages:[],hitboxSize:new f(1.7,1.4,3.2),hitLocations:{cabin:{damageMultiplier:1.1},wheels:{damageMultiplier:.9,mobilityEffect:.5},cargo:{damageMultiplier:.8},engine:{damageMultiplier:1.4},body:{damageMultiplier:1}}},CIVILIAN_TRUCK:{maxHealth:30,criticalThreshold:.5,visualDamageStages:[],hitboxSize:new f(1.7,1.4,3.2),hitLocations:{cabin:{damageMultiplier:1.2},wheels:{damageMultiplier:1,mobilityEffect:.7},cargo:{damageMultiplier:.9},engine:{damageMultiplier:1.5},body:{damageMultiplier:1}}},CAR:{maxHealth:20,criticalThreshold:.5,visualDamageStages:[],hitboxSize:new f(1.4,.8,2.2),hitLocations:{cabin:{damageMultiplier:1.2},wheels:{damageMultiplier:1,mobilityEffect:.8},engine:{damageMultiplier:1.5},body:{damageMultiplier:1}}}},te={tank_a:"TANK",tank_b:"TANK",ifv_a:"IFV",ifv_b:"IFV",civilian_truck_1:"CIVILIAN_TRUCK",civilian_truck_2:"CIVILIAN_TRUCK",civilian_truck_3:"CIVILIAN_TRUCK",military_truck_1:"MILITARY_TRUCK",military_truck_2:"MILITARY_TRUCK",military_truck_3:"MILITARY_TRUCK",car_a:"CAR",car_b:"CAR",car_c:"CAR"},se=C(((e,t)=>({vehicleHealth:{},respawnTimers:{},initVehicle:(t,s)=>{e((e=>{if(e.vehicleHealth[t])return e;const o=te[s],r=ee[o];return{vehicleHealth:{...e.vehicleHealth,[t]:{id:t,type:s,category:o,currentHealth:r.maxHealth,maxHealth:r.maxHealth,isDead:!1,isDestroyed:!1,isCritical:!1,mobilityFactor:1,visualEffects:[],hitboxSize:r.hitboxSize,damageLog:[]}}}}))},applyDamage:(s,o,r=null,i=null)=>{e((e=>{const n=e.vehicleHealth[s];if(!n||n.isDead||n.isDestroyed)return e;const a=n.category,c=ee[a];let l=1,d=0;if(r&&c.hitLocations[r]){const e=c.hitLocations[r];l=e.damageMultiplier,d=e.mobilityEffect||0}const h=o*l,u=Math.max(0,n.currentHealth-h),m=u/n.maxHealth,p=[];c.visualDamageStages.forEach((e=>{m<=e.threshold&&p.push(...e.effects)})),u<=0&&p.push("GREYED_OUT");const x=m<=c.criticalThreshold,f=u<=0;let y=n.mobilityFactor;m<=.5?y=0:d>0&&(y=Math.max(.1,y-d));const g={timestamp:Date.now(),rawDamage:o,finalDamage:h,hitLocation:r,weaponType:i,healthBefore:n.currentHealth,healthAfter:u},j={...n,currentHealth:u,healthPercentage:m,isDead:f,isCritical:x,mobilityFactor:f?0:y,visualEffects:p,damageLog:[...n.damageLog,g]};return f&&!n.isDead&&setTimeout((()=>{t().destroyVehicle(s)}),5e3),{vehicleHealth:{...e.vehicleHealth,[s]:j}}}))},destroyVehicle:s=>{e((e=>{const o=e.vehicleHealth[s];if(!o||o.isDestroyed)return e;const r=setTimeout((()=>{t().respawnVehicle(s)}),3e4),i={...e.respawnTimers,[s]:r};return{vehicleHealth:{...e.vehicleHealth,[s]:{...o,isDestroyed:!0}},respawnTimers:i}}))},respawnVehicle:t=>{e((e=>{const s=e.vehicleHealth[t];if(!s)return e;const o=s.category,r=ee[o];return{vehicleHealth:{...e.vehicleHealth,[t]:{...s,currentHealth:r.maxHealth,maxHealth:r.maxHealth,isDead:!1,isDestroyed:!1,isCritical:!1,mobilityFactor:1,visualEffects:[],damageLog:[]}}}}))},repairVehicle:(t,s=null)=>{e((e=>{const o=e.vehicleHealth[t];if(!o||o.isDestroyed)return e;const r=s?Math.min(o.maxHealth,o.currentHealth+s):o.maxHealth,i=r/o.maxHealth,n=ee[o.category];return{vehicleHealth:{...e.vehicleHealth,[t]:{...o,currentHealth:r,healthPercentage:i,isDead:!1,isCritical:i<=n.criticalThreshold,mobilityFactor:1,visualEffects:[]}}}}))},removeVehicle:t=>{e((e=>{e.respawnTimers[t]&&clearTimeout(e.respawnTimers[t]);const{[t]:s,...o}=e.vehicleHealth,{[t]:r,...i}=e.respawnTimers;return{vehicleHealth:o,respawnTimers:i}}))},getVehicleHealth:e=>se.getState().vehicleHealth[e]})));window.currentFps=60;let oe=0,re=0;if("undefined"!=typeof window){const e=()=>{const t=performance.now(),s=t-re;s>=500?(window.currentFps=oe*(1e3/s),re=t,oe=0):oe++,requestAnimationFrame(e)};requestAnimationFrame(e)}const ie={ANTI_TANK_MINE:"ANTI_TANK_MINE",RPG:"RPG",MORTAR:"MORTAR",DART:"DART",GRENADE:"GRENADE",SHOTGUN:"SHOTGUN"},ne={[ie.ANTI_TANK_MINE]:{innerRadius:8,outerRadius:20,innerDamage:30,outerDamage:10,falloff:"EXPONENTIAL",explodesOnImpact:!0,visualEffect:{radius:4,duration:10,color:16733440,intensity:2.5,secondaryEffects:{debris:{count:45,size:1.2},smoke:{volume:2,duration:1.8},shockwave:!0}}},[ie.RPG]:{innerRadius:6,outerRadius:15,innerDamage:25,outerDamage:8,falloff:"EXPONENTIAL",explodesOnImpact:!0,visualEffect:{radius:3,duration:10,color:16724736,intensity:.7,secondaryEffects:{debris:{count:35,size:.8},smoke:{volume:1.5,duration:1.3},shockwave:!0,tracer:!0}}},[ie.MORTAR]:{innerRadius:10,outerRadius:25,innerDamage:20,outerDamage:12,falloff:"EXPONENTIAL",explodesOnImpact:!0,visualEffect:{radius:3,duration:10,color:2236962,intensity:1.4,secondaryEffects:{debris:{count:60,size:1.5},smoke:{volume:2.5,duration:2},shockwave:!0,dustCloud:!0}}},[ie.DART]:{innerRadius:5,outerRadius:12,innerDamage:22,outerDamage:8,falloff:"LINEAR",explodesOnImpact:!0,visualEffect:{radius:2,duration:20,color:65535,intensity:1.5,secondaryEffects:{debris:{count:20,size:.5},smoke:{volume:1,duration:1},energyField:!0}}},[ie.GRENADE]:{innerRadius:10,outerRadius:25,innerDamage:30,outerDamage:12,falloff:"EXPONENTIAL",explodesOnImpact:!0,visualEffect:{radius:2.5,duration:35,color:16755200,intensity:2.5,secondaryEffects:{debris:{count:50,size:.9},smoke:{volume:2,duration:1.8},shockwave:!0,fragments:!0}}},[ie.SHOTGUN]:{innerRadius:4,outerRadius:10,innerDamage:18,outerDamage:6,falloff:"EXPONENTIAL",shape:"CONE",coneAngle:Math.PI/6,explodesOnImpact:!0,visualEffect:{radius:3,duration:15,color:16777130,intensity:1.5,shape:"CONE",coneAngle:Math.PI/6,secondaryEffects:{debris:{count:20,size:.3},smoke:{volume:.8,duration:.6},muzzleFlash:!0}}}};function ae(e,t,s){const o=ne[e];if(!o)return 0;const r=t.x-s.x,i=t.y-s.y,n=t.z-s.z,a=r*r+i*i+n*n;e===ie.SHOTGUN&&o.shape;if(a>o.outerRadius*o.outerRadius)return 0;if(a<=o.innerRadius*o.innerRadius)return o.innerDamage;const c=(Math.sqrt(a)-o.innerRadius)/(o.outerRadius-o.innerRadius);return"EXPONENTIAL"===o.falloff?o.innerDamage*Math.pow(1-c,2):o.innerDamage-c*(o.innerDamage-o.outerDamage)}function ce(e,t,s){const o=se.getState().applyDamage;if(!s||0===s.length||!ne[e])return;const r=ne[e],i=r.outerRadius*r.outerRadius,n=s.filter((e=>{if(!e||!e.position)return!1;const s=t.x-e.position.x,o=t.y-e.position.y,r=t.z-e.position.z;return s*s+o*o+r*r<=1.1*i}));if(0===n.length)return;const a=(s,r)=>{const i=Math.min(s+r,n.length);for(let a=s;a<i;a++){const s=n[a];if(s.userData&&s.userData.vehicleId)le(s,e,t,o);else if("function"==typeof s.takeDamage){const o=ae(e,t,s.position);o>0&&s.takeDamage(o)}}i<n.length&&setTimeout((()=>{a(i,r)}),0)};a(0,10)}function le(e,t,s,o){const r=function(e,t){const s=te[t.type],o=ee[s];if(!o)return null;const r=o.hitboxSize,i=new f(t.position.x||0,t.position.y||0,t.position.z||0),n=(new l).makeRotationFromEuler(new y(t.rotation.x||0,t.rotation.y||0,t.rotation.z||0)),a=new f(.75*r.x,.75*r.y,.75*r.z);if(new g((new f).copy(i).sub(a),(new f).copy(i).add(a)).containsPoint(e)){const t=e.clone().sub(i),o=(new l).copy(n).invert();let a;return t.applyMatrix4(o),a="TANK"===s?t.y>.3*r.y?"turret":t.y<.3*-r.y?"tracks":t.z>.3*r.z?"front":t.z<.3*-r.z?"rear":"body":"IFV"===s?t.y>.3*r.y?"turret":t.y<.3*-r.y?"wheels":t.z>.3*r.z?"front":t.z<.3*-r.z?"rear":"body":"CIVILIAN_TRUCK"===s||"MILITARY_TRUCK"===s?t.z>.2*r.z?"cabin":t.z<.2*-r.z?"cargo":t.y<.3*-r.y?"wheels":t.z>0&&t.y>0?"engine":"body":"CAR"===s?t.z>.3*r.z?"engine":t.z<.3*-r.z?"rear":t.y<.3*-r.y?"wheels":t.z>0?"cabin":"body":"body",{hit:!0,location:a,position:e.clone(),distanceFromCenter:t.length()}}return null}(s,{position:e.position,rotation:e.rotation,type:e.userData.vehicleType||"car_a"}),i=ae(t,s,e.position);i<=0||o(e.userData.vehicleId,i,r?r.location:"body",t)}function de(e){switch(e){case ie.ANTI_TANK_MINE:return"Anti-Tank Mine";case ie.RPG:return"RPG";case ie.MORTAR:return"Mortar";case ie.DART:return"Dart";case ie.GRENADE:return"Grenade";case ie.SHOTGUN:return"Shotgun";default:return"Unknown Weapon"}}function he(e){const t=e.hitbox||{width:1,height:1,depth:3},s=t.width/2;t.height;const o=t.depth/2,r=e.rotation.y||0,i=Math.abs(Math.sin(r))>.7,n=i?o:s,a=i?s:o,c=new f(e.position.x-n,e.position.y,e.position.z-a),l=new f(e.position.x+n,e.position.y+t.height,e.position.z+a);return new g(c,l)}function ue(e,t){if(t.containsPoint(e.start)||t.containsPoint(e.end))return!0;const s=(new f).subVectors(e.end,e.start).normalize(),o=e.start.distanceTo(e.end),r=new w(e.start,s),i=new f;if(r.intersectBox(t,i)){return e.start.distanceTo(i)<=o}return!1}function me(e,t){if(!e||!e.position||!t)return null;if(!e.previousPosition)return e.previousPosition=e.position.clone(),null;const s=function(e,t){const s=(t,o=[])=>{if(!t.visible||!t.userData)return o;if(t.userData.vehicleId||t.userData.isVehiclePart){if((new g).setFromObject(t).containsPoint(e)){let s="body",r=t;if(t.userData.isVehiclePart&&t.userData.partType){s=t.userData.partType;let e=t.parent;for(;e&&!e.userData.vehicleId;)e=e.parent;e&&(r=e)}o.push({vehicle:r,position:e.clone(),hitLocation:s})}}if(t.children&&t.children.length>0)for(let e of t.children)s(e,o);return o},o=[];return t.children.forEach((e=>{s(e,o)})),o.length>0?o[0]:null}(e.position,t);if(s)return s;const o=(new f).subVectors(e.position,e.previousPosition).normalize(),r=e.previousPosition.distanceTo(e.position),i=Math.max(r,5),n=(new f).copy(e.position).add(e.previousPosition).multiplyScalar(.5),a=new j(e.previousPosition,o,0,1.1*r);a.params.Line.threshold=.2,a.params.Points.threshold=.2;const c=(e,t=[])=>{if(!e.visible||!e.userData)return t;if(e.position){if(e.position.distanceToSquared(n)>i*i*1.5)return t}if((e.userData.vehicleId||e.userData.isVehiclePart||e.userData.type&&e.name&&(e.name.includes("vehicle")||e.name.includes("car")||e.name.includes("truck")||e.name.includes("tank")))&&t.push(e),e.children&&e.children.length>0)for(let s of e.children)c(s,t);return t},l=[];if(t.children.forEach((e=>{c(e,l)})),0===l.length)return null;for(const f of l){if(!f.userData.vehicleId&&!f.userData.isVehicle)continue;const t=he({position:f.position,rotation:f.rotation,hitbox:f.userData.hitbox});if(ue(new M(e.previousPosition,e.position),t)||t.containsPoint(e.position))return{vehicle:f,position:e.position.clone(),hitLocation:"body"}}const d=a.intersectObjects(l,!0);if(0===d.length)return null;const h=d[0],u=h.object,m=h.point;let p=u,x="body",y=u;for(;y&&!y.userData.vehicleId;)y.userData.isVehiclePart&&y.userData.partType&&(x=y.userData.partType),y=y.parent,y&&y.userData.vehicleId&&(p=y);u.userData.vehicleId&&(p=u),u.userData.isVehiclePart&&u.userData.partType&&(x=u.userData.partType);const w=p.userData.vehicleId;return p.userData.vehicleType,w?{vehicle:p,position:m,hitLocation:x}:null}const pe={sphere:new h(1,16,16),smallSphere:new h(1,8,8),debris:new b(1,1,1)},xe={fireballBase:new n({transparent:!0,emissive:new S(16777215)}),debrisBase:new n({transparent:!0}),smokeBase:new n({transparent:!0}),flashBase:new v({color:16777215,transparent:!0})},fe={[ie.ANTI_TANK_MINE]:{fireballColor:new S(16729344),smokeColor:new S(2236962),debrisColor:new S(7829367),dustColor:new S(10061926),lightIntensity:2.5,lightColor:16733440},[ie.RPG]:{fireballColor:new S(16737095),smokeColor:new S(3355443),debrisColor:new S(7829367),dustColor:new S(8943462),lightIntensity:3,lightColor:16724736},[ie.MORTAR]:{fireballColor:new S(11674146),smokeColor:new S(1118481),debrisColor:new S(5592405),dustColor:new S(7824981),lightIntensity:2.5,lightColor:14492194},[ie.DART]:{fireballColor:new S(8190976),smokeColor:new S(10070681),debrisColor:new S(11206570),dustColor:new S(11189162),lightIntensity:1.5,lightColor:8978176},[ie.GRENADE]:{fireballColor:new S(16766720),smokeColor:new S(5592405),debrisColor:new S(10066329),dustColor:new S(10061943),lightIntensity:2,lightColor:16755200},[ie.SHOTGUN]:{fireballColor:new S(16777130),smokeColor:new S(14540253),debrisColor:new S(14540253),dustColor:new S(13421755),lightIntensity:1,lightColor:16777130},default:{fireballColor:new S(16729344),smokeColor:new S(3355443),debrisColor:new S(8947848),dustColor:new S(11180424),lightIntensity:2,lightColor:16742144}},ye="debris",ge="smoke",je="dust",Me="shockwave",we=.02,be=.01,ve=2,Se=20,ke=60,Ie=50,Ee=15,De=10,Re={_pool:[],get:function(){return this._pool.length>0?this._pool.pop().set(0,0,0):new f(0,0,0)},release:function(e){this._pool.push(e)}};function Ge({position:s,radius:o,type:i,duration:n=30,onComplete:a,secondaryEffects:c={}}){const l=r.useRef(),[d,h]=r.useState(0),[u,m]=r.useState(.1),[p,x]=r.useState(1),[f,y]=r.useState(n),g=r.useRef(0),j=r.useRef(0),M=r.useRef(.1),w=r.useMemo((()=>{const e=fe[i]||fe.default,t=xe.fireballBase.clone();t.color=e.fireballColor.clone(),t.emissive=e.fireballColor.clone();const s=xe.debrisBase.clone();s.color=e.debrisColor.clone(),s.emissive=e.debrisColor.clone();const o=xe.smokeBase.clone();o.color=e.smokeColor.clone();const r=xe.smokeBase.clone();return r.color=e.dustColor.clone(),{fireball:t,debris:s,smoke:o,dust:r,flash:xe.flashBase.clone()}}),[i]),b=r.useMemo((()=>fe[i]||fe.default),[i]),v=r.useMemo((()=>{const e=c.debris||{count:Math.floor(5*o),size:.7},t=c.smoke||{volume:1,duration:1};return function(e,t,s,o,r,i,n){const a=[],c=2*Math.PI;for(let l=0;l<e;l++){const e=Math.random()*c,t=.01+.03*Math.random(),o=(.05+.15*Math.random())*s,i=Math.floor(r*(.7+.3*Math.random())),n=Re.get().set(Math.cos(e)*t*(.5+Math.random()),.01+.03*Math.random(),Math.sin(e)*t*(.5+Math.random()));a.push({active:!1,spawnDelay:Math.floor(3*Math.random()),position:Re.get(),velocity:n,rotation:Re.get().set(0,0,0),rotationSpeed:Re.get().set(.1*(Math.random()-.5),.1*(Math.random()-.5),.1*(Math.random()-.5)),size:o,originalSize:o,type:ye,opacity:0,targetOpacity:.7+.3*Math.random(),life:i,initialLife:i})}for(let l=0;l<t;l++){const e=Math.random()*c,t=Math.random()*o*.8,s=.003+.007*Math.random(),i=.2+.4*Math.random(),l=Math.floor(r*(.8+.4*Math.random())*n);a.push({active:!1,spawnDelay:3+Math.floor(5*Math.random()),position:Re.get().set(Math.cos(e)*t*.2,.2+.3*Math.random(),Math.sin(e)*t*.2),velocity:Re.get().set(Math.cos(e)*s*.5,.005+.01*Math.random(),Math.sin(e)*s*.5),rotation:Re.get().set(0,0,0),rotationSpeed:Re.get().set(.02*(Math.random()-.5),.02*(Math.random()-.5),.02*(Math.random()-.5)),size:i,originalSize:i,type:ge,opacity:0,targetOpacity:.4+.2*Math.random(),life:l,initialLife:l})}if(i.shockwave){const e=Math.min(De,Math.max(8,3*o));for(let t=0;t<e;t++){const s=t/e*c,o=Math.floor(.4*r);a.push({active:!1,spawnDelay:0,position:Re.get().set(0,.05,0),velocity:Re.get().set(0,0,0),rotation:Re.get().set(Math.PI/2,0,s),rotationSpeed:Re.get().set(0,0,0),angle:s,size:.2,originalSize:.2,type:Me,opacity:0,targetOpacity:.6,life:o,initialLife:o})}}if(i.dustCloud){const e=Math.min(Ee,Math.floor(4*o));for(let t=0;t<e;t++){const e=Math.random()*c,t=.3*o+Math.random()*o*.5,s=.002+.005*Math.random(),i=.3+.5*Math.random(),n=Math.floor(.6*r+Math.random()*r*.4);a.push({active:!1,spawnDelay:5+Math.floor(7*Math.random()),position:Re.get().set(0,0,0),velocity:Re.get().set(Math.cos(e)*s*t,.001+.004*Math.random(),Math.sin(e)*s*t),rotation:Re.get().set(0,0,0),rotationSpeed:Re.get().set(0,.02*(Math.random()-.5),0),size:i,originalSize:i,type:je,opacity:0,targetOpacity:.3+.2*Math.random(),life:n,initialLife:n})}}return a}(Math.min(ke,Math.floor(e.count)),Math.min(Ie,Math.floor(8*o*t.volume)),e.size,o,n,c,t.duration)}),[o,n,c]);r.useEffect((()=>()=>{Object.values(w).forEach((e=>e.dispose()))}),[w]),e((()=>{if(!l.current||f<=0)return void(f<=0&&a&&a());if(g.current++,o<ve&&g.current%2!=0)return;const e=1-f/n;if(Math.abs(e-j.current)>we&&(j.current=e,h(e),k(w,e)),u<o){const t=Math.min(1,2*e),s=.2*(o*Math.min(1,1.2*t)-M.current),r=M.current+Math.max(.05,s);Math.abs(r-M.current)>we&&(M.current=r,m(r))}if((e<.4?1!==p:p>be)&&x(e<.4?1:Math.max(0,p-1/(.6*n))),function(e){const t=Se,s=e.length;for(let o=0;o<s;o+=t){const r=Math.min(o+t,s);for(let t=o;t<r;t++){const s=e[t];if(!s.active){s.spawnDelay--,s.spawnDelay<=0&&(s.active=!0);continue}if(s.life<=0)continue;const o=1-s.life/s.initialLife;switch(s.opacity<s.targetOpacity&&(s.opacity=Math.min(s.targetOpacity,s.opacity+s.targetOpacity/10)),s.type){case Me:ze(s,o);break;case je:Pe(s,o);break;case ge:Ce(s,o);break;default:Fe(s,o)}s.life--}}}(v),y((e=>e-1)),f<=1&&a)try{a()}catch(t){}})),r.useEffect((()=>{m(.1),M.current=.1,x(1),y(n),h(0),j.current=0,g.current=0,function(e){for(let t of e)if(t.opacity=0,t.active=0===t.spawnDelay,t.life=t.initialLife,t.position.set(0,0,0),t.type===Me)t.position.set(0,.05,0);else if(t.type===ge){const e=Math.random()*Math.PI*2,s=.2*Math.random();t.position.set(Math.cos(e)*s,.2+.3*Math.random(),Math.sin(e)*s)}}(v),k(w,0)}),[s,n,v,w]);const S=r.useMemo((()=>{const e={[ye]:[],[ge]:[],[je]:[],[Me]:[]};if(Math.abs(d-j.current)<.05)return e;for(const t of v)t.active&&t.life>0&&t.opacity>be&&e[t.type].push(t);return e}),[v,d,j]);function k(e,t){e.fireball.opacity=p,e.fireball.emissiveIntensity=2*(1-.7*t),e.flash.opacity=Math.max(0,1-t/.2)}return t.jsxs("group",{ref:l,position:[s.x,s.y,s.z],children:[d<.2&&t.jsxs("mesh",{children:[t.jsx("sphereGeometry",{args:[1.2*u,16,16]}),t.jsx("primitive",{object:w.flash,attach:"material"})]}),t.jsxs("mesh",{scale:[u,u,u],children:[t.jsx("primitive",{attach:"geometry",object:pe.sphere}),t.jsx("primitive",{object:w.fireball,attach:"material"})]}),Object.entries(S).map((([e,s])=>t.jsx(Ae,{type:e,particles:s,materials:w,progress:d},e))),d<.7&&t.jsx("pointLight",{color:b.lightColor,intensity:b.lightIntensity*(1-Math.pow(d,1.5))*20,distance:15*o,decay:2})]})}function Ae({type:e,particles:s,materials:o,progress:r}){if(0===s.length)return null;let i,n=0;switch(e){case ye:i=o.debris,n=1*(1-r);break;case ge:i=o.smoke;break;case je:i=o.dust;break;case Me:i=o.dust,n=.5*(1-r);break;default:i=o.debris}return i.emissiveIntensity=n,t.jsx(t.Fragment,{children:s.map(((s,o)=>t.jsxs("mesh",{position:s.position.toArray(),rotation:s.rotation.toArray(),scale:[s.size,s.size,s.size],children:[t.jsx("primitive",{attach:"geometry",object:Te(e)}),t.jsx("meshStandardMaterial",{color:i.color,transparent:!0,opacity:s.opacity,emissive:i.color,emissiveIntensity:n})]},`${e}-${o}`)))})}function Te(e){return e===ye?pe.debris:pe.smallSphere}function ze(e,t){const s=3*t;e.position.x=Math.cos(e.angle)*s,e.position.z=Math.sin(e.angle)*s,t>.7&&(e.opacity=Math.max(0,e.targetOpacity*(1-(t-.7)/.3))),e.size=.1+.4*t}function Pe(e,t){e.position.add(e.velocity),e.size=e.originalSize*(1+.8*t),e.rotation.y+=e.rotationSpeed.y,t>.6&&(e.opacity=e.targetOpacity*Math.max(0,1-(t-.6)/.4))}function Ce(e,t){e.position.add(e.velocity);const s=t<.3?4e-4*(1-t/.3):0;e.velocity.y+=s-2e-4,e.size=e.originalSize*(1+2*t),t>.6&&(e.opacity=e.targetOpacity*Math.max(0,1-(t-.6)/.4)),e.rotation.x+=e.rotationSpeed.x,e.rotation.y+=e.rotationSpeed.y,e.rotation.z+=e.rotationSpeed.z}function Fe(e,t){e.position.add(e.velocity),e.velocity.y-=.002,e.position.y<.05&&e.velocity.y<0&&(e.velocity.y*=-.3,e.velocity.x*=.8,e.velocity.z*=.8),t>.7&&(e.opacity=e.targetOpacity*Math.max(0,1-(t-.7)/.3));const{rotationSpeed:s,rotation:o}=e;o.x+=s.x,o.y+=s.y,o.z+=s.z}function Ne(){const[e,o]=r.useState([]),{scene:i}=s(),n=r.useRef(new Map),a=r.useRef(new Map);r.useEffect((()=>{const e=()=>{const e=new Map,t=s=>{(s.userData&&(s.userData.vehicleId||s.userData.isVehiclePart||s.userData.parentVehicleId||s.userData.vehicleType)||s.isMesh)&&e.set(s.id,s),s.children&&s.children.length>0&&s.children.forEach(t)};i.children.forEach(t),n.current=e};e();const t=setInterval(e,2e3);return()=>{clearInterval(t)}}),[i]),r.useEffect((()=>{const e=e=>{const{position:t,weaponType:s}=e.detail;if(s===ie.SHOTGUN){const e=2*ne[s].outerRadius,o=c(t,e);return void(o.length>0&&requestAnimationFrame((()=>{ce(s,t,o)})))}const r=function(e,t){var s,o,r,i;const n=window.performance&&window.performance.now?Math.min(1,60/(window.currentFps||60)):1,a=ne[e];if(e===ie.SHOTGUN)return{position:t.clone(),radius:a.outerRadius/3,duration:1,type:e,startTime:Date.now()};const c=a.visualEffect,l=Math.floor(((null==(s=c.secondaryEffects.debris)?void 0:s.count)||0)*n),d=((null==(o=c.secondaryEffects.smoke)?void 0:o.volume)||0)*n;return{position:t.clone(),radius:c.radius*n,duration:c.duration,color:c.color,intensity:c.intensity*n,shape:c.shape||"SPHERE",coneAngle:c.coneAngle,secondaryEffects:{debris:{count:l,size:(null==(r=c.secondaryEffects.debris)?void 0:r.size)||0},smoke:{volume:d,duration:(null==(i=c.secondaryEffects.smoke)?void 0:i.duration)||0},shockwave:c.secondaryEffects.shockwave&&n>.7,dustCloud:c.secondaryEffects.dustCloud&&n>.7,energyField:c.secondaryEffects.energyField&&n>.8,fragments:c.secondaryEffects.fragments&&n>.7,muzzleFlash:c.secondaryEffects.muzzleFlash,tracer:c.secondaryEffects.tracer},type:e,startTime:Date.now(),quality:n}}(s,t),i=6*r.radius,n=c(t,i);n.length>0&&requestAnimationFrame((()=>{ce(s,t,n)}));const l=`explosion-${Date.now().toString(36)}-${Math.random().toString(36).substr(2,5)}`;a.current.set(l,Date.now()),o((e=>[...e,{...r,id:l}]))};return window.addEventListener("weapon-impact",e),()=>{window.removeEventListener("weapon-impact",e)}}),[i]),r.useEffect((()=>{const e=setInterval((()=>{const e=Date.now();let t=!1;a.current.forEach(((s,o)=>{e-s>5e3&&(a.current.delete(o),t=!0)})),t&&o((e=>{const t=Array.from(a.current.keys());return e.filter((e=>t.includes(e.id)))}))}),1e3);return()=>clearInterval(e)}),[]);const c=(e,t)=>{const s=[],o=e.clone(),r=t*t,n=e=>{if(!e.position)return;const t=new f;e.getWorldPosition(t);const i=t.x-o.x,a=t.y-o.y,c=t.z-o.z;if(i*i+a*a+c*c<=r&&s.push(e),e.children&&e.children.length>0)for(const s of e.children)n(s)};return i.children.forEach(n),s};return t.jsx(t.Fragment,{children:e.map((e=>t.jsx(Ge,{position:e.position,radius:e.radius,type:e.type,duration:e.duration,secondaryEffects:e.secondaryEffects,onComplete:()=>{return t=e.id,a.current.delete(t),void o((e=>e.filter((e=>e.id!==t))));var t}},e.id)))})}function _e(e,t){const s=new CustomEvent("weapon-impact",{detail:{position:e,weaponType:t}});window.dispatchEvent(s)}function Oe({position:s,damage:o,duration:i=60}){const n=r.useRef(),[a,c]=r.useState(i),[l,d]=r.useState(0);return e((()=>{n.current&&(d((e=>e+.02)),n.current&&(c((e=>e-1)),a<.3*i&&n.current.children.forEach((e=>{e.material&&(e.material.opacity=a/(.3*i))}))))})),t.jsx("group",{ref:n,position:[s.x,s.y+1+l,s.z],lookAt:[s.x,s.y+10,s.z-5],children:t.jsx(R,{color:o>=15?"red":o>=10?"orange":"yellow",fontSize:.5,anchorX:"center",anchorY:"middle",outlineWidth:.05,outlineColor:"#000000","material-transparent":!0,children:o.toFixed(0)})})}function Le(){const[e,s]=r.useState([]);return k.useEffect((()=>{const e=e=>{const{position:t,damage:o}=e.detail;s((e=>[...e,{id:`damage-${Date.now()}-${Math.random()}`,position:t.clone(),damage:o,createdAt:Date.now()}])),setTimeout((()=>{s((e=>e.filter((e=>e.createdAt>Date.now()-2e3))))}),2e3)};return window.addEventListener("damage-dealt",e),()=>{window.removeEventListener("damage-dealt",e)}}),[]),t.jsx(t.Fragment,{children:e.map((e=>t.jsx(Oe,{position:e.position,damage:e.damage},e.id)))})}function He(e,t){const s=new CustomEvent("damage-dealt",{detail:{position:e.clone(),damage:t}});window.dispatchEvent(s)}function $e({position:s,direction:o,onComplete:i}){const[n,a]=r.useState(10),c=r.useRef(),l=r.useRef([]);r.useEffect((()=>{const e=[];for(let s=0;s<15;s++){const t=Math.random()*Math.PI*2,s=.3*Math.random();e.push({position:new f(Math.cos(t)*s,Math.sin(t)*s,-.5-.5*Math.random()),size:.05+.1*Math.random(),opacity:.7+.3*Math.random(),color:new S(.9+.1*Math.random(),.7+.2*Math.random(),.2+.2*Math.random())})}for(let s=0;s<8;s++){const t=.2*Math.random(),s=.5+1*Math.random(),o=Math.random()*Math.PI*2;e.push({position:new f(Math.cos(o)*t,Math.sin(o)*t,-s),size:.03+.05*Math.random(),opacity:.5+.3*Math.random(),color:new S(.8,.8,.8)})}l.current=e;const t=setTimeout((()=>{i&&i()}),200);return()=>clearTimeout(t)}),[i]),e((()=>{n<=0||a((e=>e-1))}));const d=r.useMemo((()=>{if(!o)return[0,0,0];const e=new f(0,0,-1),t=(new f).copy(o).normalize(),s=(new I).setFromUnitVectors(e,t),r=(new y).setFromQuaternion(s);return[r.x,r.y,r.z]}),[o]);if(n<=0)return null;const h=n/10;return t.jsxs("group",{ref:c,position:[s.x,s.y,s.z],rotation:d,children:[t.jsxs("mesh",{children:[t.jsx("sphereGeometry",{args:[.2,8,8]}),t.jsx("meshBasicMaterial",{color:16768392,transparent:!0,opacity:.8*h})]}),t.jsxs("mesh",{position:[0,0,-.1],children:[t.jsx("coneGeometry",{args:[.3,.6,8]}),t.jsx("meshBasicMaterial",{color:16777130,transparent:!0,opacity:.6*h})]}),l.current.map(((e,s)=>t.jsxs("mesh",{position:e.position.toArray(),children:[t.jsx("sphereGeometry",{args:[e.size,6,6]}),t.jsx("meshBasicMaterial",{color:e.color,transparent:!0,opacity:e.opacity*h})]},s))),t.jsx("pointLight",{color:16768392,intensity:6*h,distance:3,decay:2})]})}function Ve(){const[e,s]=r.useState([]);r.useEffect((()=>{const e=e=>{const{position:t,direction:o,weaponType:r}=e.detail;if(r!==ie.SHOTGUN)return;const i=`flash-${Date.now().toString(36)}-${Math.random().toString(36).substr(2,5)}`;s((e=>[...e,{id:i,position:t,direction:o||new f(0,0,-1)}]))};window.addEventListener("shotgun-fire",e);const t=e=>{const{position:t,weaponType:o,direction:r}=e.detail;if(o!==ie.SHOTGUN)return;const i=`impact-${Date.now().toString(36)}-${Math.random().toString(36).substr(2,5)}`;s((e=>[...e,{id:i,position:t,direction:r||new f(0,0,-1),isImpact:!0}]))};return window.addEventListener("weapon-impact",t),()=>{window.removeEventListener("shotgun-fire",e),window.removeEventListener("weapon-impact",t)}}),[]);return t.jsx(t.Fragment,{children:e.map((e=>t.jsx($e,{position:e.position,direction:e.direction,onComplete:()=>{return t=e.id,void s((e=>e.filter((e=>e.id!==t))));var t},isImpact:e.isImpact},e.id)))})}document.addEventListener("keydown",(e=>{e.code})),document.addEventListener("keyup",(e=>{e.code}));const Be={[ie.SHOTGUN]:16,[ie.GRENADE]:3,[ie.DART]:3};function Ue(){const o=r.useRef();r.useRef(new f(0,0,0));const i=r.useRef(new f(0,0,0)),n=r.useRef([]),a=r.useRef(new y(0,0,0,"YXZ")),[c,l]=r.useState([0,10,0]),[d,h]=r.useState(!1),[u,m]=r.useState(0),[p,x]=r.useState(12),[g,j]=r.useState(6),[M,w]=r.useState(9),[b,v]=r.useState(!1),[S,k]=r.useState(!1),[D,R]=r.useState(!1),A=r.useRef({[ie.SHOTGUN]:[],[ie.GRENADE]:[],[ie.DART]:[]}),[T,z]=r.useState([]),{camera:P,scene:C}=s(),[F,N]=G(),[_,O]=r.useState(!1);r.useEffect((()=>{Object.entries(Be).forEach((([e,t])=>{for(let s=0;s<t;s++)A.current[e].push({id:`${e}-${s}`,position:new f,previousPosition:new f,direction:new f,type:e,speed:0,life:0,active:!1,gravity:0})}))}),[]);const L=.05,H=e=>{const t=A.current[e],s=t.find((e=>!e.active));if(s)return s.active=!0,s;if(t.length<25){const s={id:`${e}-${t.length}`,position:new f,previousPosition:new f,direction:new f,type:e,speed:0,life:0,active:!0,gravity:0};return t.push(s),s}return null},$=e=>{const t=A.current[e.type].find((t=>t.id===e.id));t&&(t.active=!1,t.life=0)},V=r.useCallback((()=>{if(p<=0||b)return;x((e=>e-1)),v(!0);const e=o.current.rotation.y,t=new f(-Math.sin(e),0,-Math.cos(e));!function(e,t){const s=new CustomEvent("shotgun-fire",{detail:{position:e,direction:t,weaponType:ie.SHOTGUN}});window.dispatchEvent(s)}(o.current.position.clone().add(t.clone().multiplyScalar(1)),t);for(let s=0;s<3;s++){const e=new f(.2*(Math.random()-.5),.1*(Math.random()-.5),.2*(Math.random()-.5)),s=t.clone().add(e).normalize(),r=H(ie.SHOTGUN);r&&(r.position.copy(o.current.position).add(s.clone().multiplyScalar(1.5)),r.previousPosition||(r.previousPosition=new f),r.previousPosition.copy(r.position),r.direction.copy(s),r.speed=.8+.4*Math.random(),r.life=40,z((e=>[...e,r])))}setTimeout((()=>{v(!1)}),800)}),[p,b]);r.useEffect((()=>(P.position.set(0,15,20),P.lookAt(0,10,0),o.current&&(o.current.rotation.order="YXZ",o.current.rotation.x=a.current.x,o.current.rotation.y=a.current.y,o.current.rotation.z=a.current.z),F((e=>e),(e=>{const{forward:t,backward:s,left:o,right:r,up:i,down:n,strafeLeft:a,strafeRight:c}=e;t||s||o||r||i||n||a||c?(h(!0),m(1)):m(.5)})))),[P,F]),r.useEffect((()=>{const e=e=>{switch(e.button){case 0:V();break;case 2:(()=>{if(g<=0||S)return;j(g-1),k(!0);const e=o.current.position,t=H(ie.GRENADE);t.position.set(e.x,e.y-.5,e.z),t.previousPosition||(t.previousPosition=new f),t.previousPosition.copy(t.position),t.direction.set(0,-1,0),t.speed=.4,t.life=70,t.gravity=.005,z((e=>[...e,t])),setTimeout((()=>{k(!1)}),1200)})()}},t=e=>{switch(e.key){case"c":case"C":(()=>{if(M<=0||D)return;w(M-1),R(!0);const e=o.current.position,t=H(ie.DART);t.position.set(e.x,e.y-.5,e.z),t.previousPosition||(t.previousPosition=new f),t.previousPosition.copy(t.position),t.direction.set(0,-1,0),t.speed=.6,t.life=60,t.gravity=.008,z((e=>[...e,t])),setTimeout((()=>{R(!1)}),1e3)})();break;case"v":case"V":O((e=>!e))}},s=e=>{e.preventDefault()};return window.addEventListener("mousedown",e),window.addEventListener("keydown",t),window.addEventListener("contextmenu",s),()=>{window.removeEventListener("mousedown",e),window.removeEventListener("keydown",t),window.removeEventListener("contextmenu",s)}}),[p,g,M,b,S,D]);const B=(e,t)=>{setTimeout((()=>{_e(e,t),He(e,20)}),0)};return e((()=>{z((e=>{if(0===e.length)return e;const t=[];for(const s of e){if(s.life<=0){B(s.position,s.type),$(s);continue}if(s.position.y<=.1){B(s.position,s.type),$(s);continue}const e=me(s,C);e?(B(e.position,s.type),$(s)):(s.previousPosition||(s.previousPosition=new f),s.previousPosition.copy(s.position),s.position.add(s.direction.clone().multiplyScalar(s.speed)),s.gravity&&(s.direction.y-=s.gravity),s.life--,t.push(s))}return t}))})),e(((e,t)=>{if(!o.current)return;const{forward:s,backward:r,left:n,right:a,up:c,down:d,strafeLeft:h,strafeRight:u,shift:m}=N(),p=o.current.rotation.y,x=new f(-Math.sin(p),0,-Math.cos(p)),g=new f(Math.cos(p),0,-Math.sin(p));if(s&&(i.current.add(x.clone().multiplyScalar(.1)),i.current.y-=.005),r&&(i.current.add(x.clone().multiplyScalar(-.05)),i.current.y+=.004),n&&(o.current.rotation.y=E.lerp(o.current.rotation.y,o.current.rotation.y+.14,.2)),a&&(o.current.rotation.y=E.lerp(o.current.rotation.y,o.current.rotation.y-.14,.2)),h&&i.current.add(g.clone().multiplyScalar(-.04)),u&&i.current.add(g.clone().multiplyScalar(.04)),c)i.current.y+=L;else if(d){const e=m?1.5*L:L;i.current.y-=e}else i.current.y-=.004;i.current.multiplyScalar(.98);i.current.length()>2&&i.current.normalize().multiplyScalar(2),o.current.position.add(i.current),o.current.position.y<1&&(o.current.position.y=1,i.current.y=0);let j=0,M=0;s&&(j=-.3),r&&(j=.3),h&&(M=.2),u&&(M=-.2);const w=o.current.rotation.y,b=new I;b.setFromEuler(o.current.rotation);const v=new y(j,w,M,"YXZ"),S=new I;S.setFromEuler(v);const k=(new I).copy(b);k.slerp(S,.1),o.current.setRotationFromQuaternion(k);const D=new f(o.current.position.x,o.current.position.y,o.current.position.z);if(_)P.position.set(o.current.position.x,o.current.position.y-3,o.current.position.z),P.lookAt(o.current.position.x,0,o.current.position.z);else{const e=new f(25*Math.sin(p),8,25*Math.cos(p));P.position.copy(D).add(e),P.lookAt(o.current.position.x,o.current.position.y+.5,o.current.position.z)}l([o.current.position.x,o.current.position.y,o.current.position.z])})),t.jsxs(t.Fragment,{children:[t.jsxs("group",{ref:o,children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[0,0,0],children:[t.jsx("boxGeometry",{args:[.8,.35,2]}),t.jsx("meshStandardMaterial",{color:"#1d3557",metalness:.7,roughness:.2})]}),t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[.4,0,0],rotation:[0,0,Math.PI/4],children:[t.jsx("boxGeometry",{args:[.25,.35,2]}),t.jsx("meshStandardMaterial",{color:"#2a4568",metalness:.7,roughness:.2})]}),t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[-.4,0,0],rotation:[0,0,-Math.PI/4],children:[t.jsx("boxGeometry",{args:[.25,.35,2]}),t.jsx("meshStandardMaterial",{color:"#2a4568",metalness:.7,roughness:.2})]}),t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[0,0,1],rotation:[Math.PI/4,0,0],children:[t.jsx("boxGeometry",{args:[.8,.25,.25]}),t.jsx("meshStandardMaterial",{color:"#2a4568",metalness:.7,roughness:.2})]}),t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[0,0,-1],rotation:[-Math.PI/4,0,0],children:[t.jsx("boxGeometry",{args:[.8,.25,.25]}),t.jsx("meshStandardMaterial",{color:"#2a4568",metalness:.7,roughness:.2})]}),t.jsxs("mesh",{castShadow:!0,position:[0,0,0],rotation:[0,Math.PI/4,0],children:[t.jsx("boxGeometry",{args:[3,.08,.1]}),t.jsx("meshStandardMaterial",{color:"#e63946",metalness:.4,roughness:.6})]}),t.jsxs("mesh",{castShadow:!0,position:[0,0,0],rotation:[0,-Math.PI/4,0],children:[t.jsx("boxGeometry",{args:[3,.08,.1]}),t.jsx("meshStandardMaterial",{color:"#e63946",metalness:.4,roughness:.6})]}),t.jsx(Ye,{position:[.6,-.3,.6]}),t.jsx(Ye,{position:[-.6,-.3,.6]}),t.jsx(Ye,{position:[.6,-.3,-.6]}),t.jsx(Ye,{position:[-.6,-.3,-.6]}),t.jsx(Ke,{position:[1.1,0,1.1],index:0,propRef:e=>n.current[0]=e,active:d,speed:u}),t.jsx(Ke,{position:[-1.1,0,1.1],index:1,propRef:e=>n.current[1]=e,active:d,speed:u,counterClockwise:!0}),t.jsx(Ke,{position:[1.1,0,-1.1],index:2,propRef:e=>n.current[2]=e,active:d,speed:u,counterClockwise:!0}),t.jsx(Ke,{position:[-1.1,0,-1.1],index:3,propRef:e=>n.current[3]=e,active:d,speed:u}),t.jsxs("group",{position:[0,-.3,-1],rotation:[Math.PI/2,0,Math.PI],children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[-.25,0,-.2],children:[t.jsx("cylinderGeometry",{args:[.15,.15,2.4,12]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.8,roughness:.2})]}),t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[.25,0,-.2],children:[t.jsx("cylinderGeometry",{args:[.15,.15,2.4,12]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.8,roughness:.2})]})]}),t.jsxs("group",{position:[0,-.35,1],rotation:[-Math.PI/2,0,0],children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[0,0,.15],children:[t.jsx("boxGeometry",{args:[1,.5,.3]}),t.jsx("meshStandardMaterial",{color:"#4a5568",metalness:.6,roughness:.3})]}),[...Array(4)].map(((e,s)=>t.jsxs("mesh",{position:[.22*(s-1.5),0,0],castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.08,.08,.3,10]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.7,roughness:.4})]},s))),t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[0,.15,.15],children:[t.jsx("boxGeometry",{args:[1,.08,.08]}),t.jsx("meshStandardMaterial",{color:"#e63946",metalness:.6,roughness:.4})]}),t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[0,-.15,.15],children:[t.jsx("boxGeometry",{args:[1,.08,.08]}),t.jsx("meshStandardMaterial",{color:"#e63946",metalness:.6,roughness:.4})]})]}),t.jsxs("group",{position:[0,-.4,0],rotation:[-Math.PI/2,0,0],children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[0,0,.1],children:[t.jsx("boxGeometry",{args:[.8,.25,.2]}),t.jsx("meshStandardMaterial",{color:"#4a5568",metalness:.6,roughness:.3})]}),[...Array(5)].map(((e,s)=>t.jsxs("mesh",{position:[.15*(s-2),0,0],castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.03,.03,.15,8]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.7,roughness:.4})]},s))),t.jsxs("mesh",{position:[0,.15,.1],children:[t.jsx("boxGeometry",{args:[.2,.1,.1]}),t.jsx("meshStandardMaterial",{color:"#ff5733",emissive:"#ff5733",emissiveIntensity:.5})]})]})]}),t.jsx(Xe,{projectiles:T})]})}function Ke({position:s,index:o,propRef:i,active:n=!0,speed:a=1,counterClockwise:c=!1}){r.useRef();const l=r.useRef(),d=c?-1:1;return e((()=>{l.current&&n&&(l.current.rotation.y+=.5*a*d),i&&i(l.current)})),t.jsxs("group",{position:s,children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.15,.18,.2,12]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.7,roughness:.3})]}),t.jsxs("mesh",{castShadow:!0,position:[0,.12,0],children:[t.jsx("cylinderGeometry",{args:[.12,.12,.05,12]}),t.jsx("meshStandardMaterial",{color:"#8d99ae",metalness:.8,roughness:.2})]}),t.jsxs("group",{ref:l,position:[0,.15,0],children:[t.jsxs("mesh",{castShadow:!0,children:[t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.5,roughness:.6}),t.jsxs("bufferGeometry",{children:[t.jsx("bufferAttribute",{attach:"attributes-position",count:12,itemSize:3,array:new Float32Array([0,0,0,.6,.02,-.1,.6,-.02,.1,0,0,0,.6,-.02,.1,1.2,0,0,0,0,0,1.2,0,0,.6,.02,-.1,.6,.02,-.1,1.2,0,0,.6,-.02,.1])}),t.jsx("bufferAttribute",{attach:"attributes-normal",count:12,itemSize:3,array:new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0])})]})]}),t.jsxs("mesh",{castShadow:!0,rotation:[0,Math.PI,0],children:[t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.5,roughness:.6}),t.jsxs("bufferGeometry",{children:[t.jsx("bufferAttribute",{attach:"attributes-position",count:12,itemSize:3,array:new Float32Array([0,0,0,.6,.02,-.1,.6,-.02,.1,0,0,0,.6,-.02,.1,1.2,0,0,0,0,0,1.2,0,0,.6,.02,-.1,.6,.02,-.1,1.2,0,0,.6,-.02,.1])}),t.jsx("bufferAttribute",{attach:"attributes-normal",count:12,itemSize:3,array:new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0])})]})]}),t.jsxs("mesh",{children:[t.jsx("sphereGeometry",{args:[.06,8,8]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.7,roughness:.2})]})]})]})}function Ye({position:e}){return t.jsxs("group",{position:e,children:[t.jsxs("mesh",{castShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.04,.04,.6,8]}),t.jsx("meshStandardMaterial",{color:"#64748b",metalness:.6,roughness:.4})]}),t.jsxs("mesh",{castShadow:!0,position:[0,-.35,0],children:[t.jsx("sphereGeometry",{args:[.08,8,8]}),t.jsx("meshStandardMaterial",{color:"#475569",metalness:.4,roughness:.6})]})]})}function Xe({projectiles:e}){const s=r.useMemo((()=>({[ie.SHOTGUN]:new h(.05,3,3),[ie.GRENADE]:new h(.15,6,6),[ie.DART]:new h(.1,6,6)})),[]),o=r.useMemo((()=>({[ie.SHOTGUN]:new v({color:"gray"}),[ie.GRENADE]:new v({color:"gold"}),[ie.DART]:new v({color:"limegreen"})})),[]),i=r.useMemo((()=>{const t={[ie.SHOTGUN]:[],[ie.GRENADE]:[],[ie.DART]:[]};return e.forEach((e=>{t[e.type]&&t[e.type].push(e)})),t}),[e]);return t.jsx(t.Fragment,{children:Object.entries(i).map((([e,r])=>r.map((r=>t.jsx("mesh",{position:[r.position.x,r.position.y,r.position.z],geometry:s[e],material:o[e]},r.id)))))})}function qe(){const o=r.useRef();r.useRef(new f(0,0,0));const i=r.useRef(new f(0,0,0)),n=r.useRef([]),a=r.useRef(new y(0,0,0,"YXZ")),[c,l]=r.useState([0,10,0]),[d,h]=r.useState(!1),[u,m]=r.useState(0),{camera:p}=s(),[x,g]=G(),j=.08;return r.useEffect((()=>(p.position.set(0,15,20),p.lookAt(0,10,0),o.current&&(o.current.rotation.order="YXZ",o.current.rotation.x=a.current.x,o.current.rotation.y=a.current.y,o.current.rotation.z=a.current.z),x((e=>e),(e=>{const{forward:t,backward:s,left:o,right:r,up:i,down:n,strafeLeft:a,strafeRight:c}=e;t||s||o||r||i||n||a||c?(h(!0),m(1)):m(.5)})))),[p,x]),e(((e,t)=>{if(!o.current)return;const{forward:s,backward:r,left:n,right:a,up:c,down:d,strafeLeft:h,strafeRight:u,shift:m}=g(),x=o.current.rotation.y,M=new f(-Math.sin(x),0,-Math.cos(x)),w=new f(Math.cos(x),0,-Math.sin(x));if(s&&(i.current.add(M.clone().multiplyScalar(.1)),i.current.y-=.015),r&&(i.current.add(M.clone().multiplyScalar(-.05)),i.current.y+=.012),n&&(o.current.rotation.y=E.lerp(o.current.rotation.y,o.current.rotation.y+.18,.2)),a&&(o.current.rotation.y=E.lerp(o.current.rotation.y,o.current.rotation.y-.18,.2)),h&&i.current.add(w.clone().multiplyScalar(-.04)),u&&i.current.add(w.clone().multiplyScalar(.04)),c)i.current.y+=j;else if(d){const e=m?.12:j;i.current.y-=e}else i.current.y-=.003;i.current.multiplyScalar(.98);i.current.length()>9&&i.current.normalize().multiplyScalar(9),o.current.position.add(i.current),o.current.position.y<1&&(o.current.position.y=1,i.current.y=0);let b=0,v=0;s&&(b=-.3),r&&(b=.3),h&&(v=.2),u&&(v=-.2);const S=o.current.rotation.y,k=new I;k.setFromEuler(o.current.rotation);const D=new y(b,S,v,"YXZ"),R=new I;R.setFromEuler(D);const G=(new I).copy(k);G.slerp(R,.1),o.current.setRotationFromQuaternion(G);const A=new f(o.current.position.x,o.current.position.y,o.current.position.z),T=new f(15*Math.sin(x),6,15*Math.cos(x));p.position.copy(A).add(T),p.lookAt(o.current.position.x,o.current.position.y+.5,o.current.position.z),l([o.current.position.x,o.current.position.y,o.current.position.z])})),t.jsxs("group",{ref:o,position:c,children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[0,0,0],children:[t.jsx("boxGeometry",{args:[.3,.1,.7]}),t.jsx("meshStandardMaterial",{color:"#ff3300",metalness:.7,roughness:.2})]}),t.jsxs("mesh",{castShadow:!0,position:[0,0,0],rotation:[0,Math.PI/4,0],children:[t.jsx("boxGeometry",{args:[1.414,.03,.05]}),t.jsx("meshStandardMaterial",{color:"#4a4a4a",metalness:.4,roughness:.6})]}),t.jsxs("mesh",{castShadow:!0,position:[0,0,0],rotation:[0,-Math.PI/4,0],children:[t.jsx("boxGeometry",{args:[1.414,.03,.05]}),t.jsx("meshStandardMaterial",{color:"#4a4a4a",metalness:.4,roughness:.6})]}),t.jsx(We,{position:[.1,-.1,.4]}),t.jsx(We,{position:[-.1,-.1,.4]}),t.jsx(We,{position:[.1,-.1,-.4]}),t.jsx(We,{position:[-.1,-.1,-.4]}),t.jsx(Ze,{position:[.5,0,.5],index:0,propRef:e=>n.current[0]=e,active:d,speed:u}),t.jsx(Ze,{position:[-.5,0,.5],index:1,propRef:e=>n.current[1]=e,active:d,speed:u,counterClockwise:!0}),t.jsx(Ze,{position:[.5,0,-.5],index:2,propRef:e=>n.current[2]=e,active:d,speed:u,counterClockwise:!0}),t.jsx(Ze,{position:[-.5,0,-.5],index:3,propRef:e=>n.current[3]=e,active:d,speed:u}),t.jsxs("mesh",{position:[0,.16,0],children:[t.jsx("boxGeometry",{args:[.25,.2,.35]}),t.jsx("meshStandardMaterial",{color:"#0000ff"})]}),t.jsxs("group",{children:[t.jsxs("mesh",{position:[0,-.2,0],rotation:[Math.PI/2,0,0],children:[t.jsx("cylinderGeometry",{args:[.15,.25,1.2,8]}),t.jsx("meshStandardMaterial",{color:"#004d00",metalness:.7,roughness:.5})]}),t.jsxs("mesh",{position:[0,-.2,-.8],rotation:[-Math.PI/2,0,0],children:[t.jsx("coneGeometry",{args:[.25,.5,8]}),t.jsx("meshStandardMaterial",{color:"#2e7d32",metalness:.7,roughness:.5})]})]})]})}function Ze({position:s,index:o,propRef:i,active:n=!0,speed:a=1,counterClockwise:c=!1}){const l=r.useRef(),d=c?-1:1;return e((()=>{l.current&&n&&(l.current.rotation.y+=.5*a*d),i&&i(l.current)})),t.jsxs("group",{position:s,children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.05,.07,.1,12]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.7,roughness:.3})]}),t.jsxs("mesh",{castShadow:!0,position:[0,.05,0],children:[t.jsx("cylinderGeometry",{args:[.05,.05,.02,12]}),t.jsx("meshStandardMaterial",{color:"#8d99ae",metalness:.8,roughness:.2})]}),t.jsxs("group",{ref:l,position:[0,.1,0],children:[t.jsxs("mesh",{castShadow:!0,children:[t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.5,roughness:.6}),t.jsxs("bufferGeometry",{children:[t.jsx("bufferAttribute",{attach:"attributes-position",count:12,itemSize:3,array:new Float32Array([0,0,0,.15,.02,-.025,.15,-.02,.025,0,0,0,.15,-.02,.025,.3,0,0,0,0,0,.3,0,0,.15,.02,-.025,.15,.02,-.025,.3,0,0,.15,-.02,.025])}),t.jsx("bufferAttribute",{attach:"attributes-normal",count:12,itemSize:3,array:new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0])})]})]}),t.jsxs("mesh",{castShadow:!0,rotation:[0,Math.PI,0],children:[t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.5,roughness:.6}),t.jsxs("bufferGeometry",{children:[t.jsx("bufferAttribute",{attach:"attributes-position",count:12,itemSize:3,array:new Float32Array([0,0,0,.15,.02,-.025,.15,-.02,.025,0,0,0,.15,-.02,.025,.3,0,0,0,0,0,.3,0,0,.15,.02,-.025,.15,.02,-.025,.3,0,0,.15,-.02,.025])}),t.jsx("bufferAttribute",{attach:"attributes-normal",count:12,itemSize:3,array:new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0])})]})]}),t.jsxs("mesh",{children:[t.jsx("sphereGeometry",{args:[.04,8,8]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.7,roughness:.2})]})]})]})}function We({position:e}){return t.jsxs("mesh",{castShadow:!0,position:e,children:[t.jsx("cylinderGeometry",{args:[.02,.02,.3,8]}),t.jsx("meshStandardMaterial",{color:"#64748b",metalness:.6,roughness:.4})]})}const Qe={[ie.ANTI_TANK_MINE]:3,[ie.MORTAR]:3,[ie.RPG]:3};function Je(){const o=r.useRef();r.useRef(new f(0,0,0));const i=r.useRef(new f(0,0,0)),n=r.useRef([]),a=r.useRef(new y(0,0,0,"YXZ")),[c,l]=r.useState([0,10,0]),[d,h]=r.useState(!1),[u,m]=r.useState(0),[p,x]=r.useState(!0),[g,j]=r.useState(3),[M,w]=r.useState(5),[b,v]=r.useState(4),[S,k]=r.useState(!1),[D,R]=r.useState(!1),[A,T]=r.useState(!1),z=r.useRef({[ie.ANTI_TANK_MINE]:[],[ie.MORTAR]:[],[ie.RPG]:[]}),[P,C]=r.useState([]),{camera:F,scene:N}=s(),[_,O]=G(),[L,H]=r.useState(!1);r.useEffect((()=>{Object.entries(Qe).forEach((([e,t])=>{for(let s=0;s<t;s++)z.current[e].push({id:`${e}-${s}`,position:new f,previousPosition:new f,direction:new f,type:e,speed:0,life:0,active:!1,gravity:0})}))}),[]);const $=e=>{const t=z.current[e],s=t.find((e=>!e.active));if(s)return s.active=!0,s;const o={id:`${e}-${t.length}`,position:new f,previousPosition:new f,direction:new f,type:e,speed:0,life:0,active:!0,gravity:0};return t.push(o),o},V=e=>{const t=z.current[e.type].find((t=>t.id===e.id));t&&(t.active=!1,t.life=0)},B=.04;r.useEffect((()=>(F.position.set(0,15,20),F.lookAt(0,10,0),o.current&&(o.current.rotation.order="YXZ",o.current.rotation.x=a.current.x,o.current.rotation.y=a.current.y,o.current.rotation.z=a.current.z),_((e=>e),(e=>{const{forward:t,backward:s,left:o,right:r,up:i,down:n,strafeLeft:a,strafeRight:c}=e;t||s||o||r||i||n||a||c?(h(!0),m(1)):m(.5)})))),[F,_]),r.useEffect((()=>{const e=e=>{switch(e.button){case 0:if(g>0&&!S){j((e=>e-1)),k(!0);const e=$(ie.ANTI_TANK_MINE);e.position.set(o.current.position.x,o.current.position.y-.5,o.current.position.z),e.previousPosition||(e.previousPosition=new f),e.previousPosition.copy(e.position),e.direction.set(0,-1,0),e.speed=.3,e.life=80,e.gravity=.005,C((t=>[...t,e])),setTimeout((()=>k(!1)),1e3)}break;case 2:if(M>0&&!D){w((e=>e-1)),R(!0);const e=$(ie.MORTAR);e.position.set(o.current.position.x,o.current.position.y-.5,o.current.position.z),e.previousPosition||(e.previousPosition=new f),e.previousPosition.copy(e.position),e.direction.set(0,-1,0),e.speed=.5,e.life=60,e.gravity=.006,C((t=>[...t,e])),setTimeout((()=>R(!1)),1e3)}}},t=e=>{if("c"===e.key||"C"===e.key){if(b>0&&!A){v((e=>e-1)),T(!0);const e=$(ie.RPG);e.position.set(o.current.position.x,o.current.position.y-.5,o.current.position.z),e.previousPosition||(e.previousPosition=new f),e.previousPosition.copy(e.position),e.direction.set(0,-1,0),e.speed=.6,e.life=40,e.gravity=.008,C((t=>[...t,e])),setTimeout((()=>T(!1)),1e3)}}else"v"!==e.key&&"V"!==e.key||H((e=>!e))},s=e=>{e.preventDefault()};return window.addEventListener("mousedown",e),window.addEventListener("keydown",t),window.addEventListener("contextmenu",s),()=>{window.removeEventListener("mousedown",e),window.removeEventListener("keydown",t),window.removeEventListener("contextmenu",s)}}),[g,M,b,S,D,A]);const U=(e,t)=>{setTimeout((()=>{_e(e,t),He(e,20)}),0)};return e((()=>{C((e=>{const t=[];for(const s of e){if(s.life<=0){U(s.position,s.type),V(s);continue}if(s.position.y<=.1){U(s.position,s.type),V(s);continue}const e=me(s,N);e?(U(e.position,s.type),V(s)):(s.previousPosition||(s.previousPosition=new f),s.previousPosition.copy(s.position),s.position.add(s.direction.clone().multiplyScalar(s.speed)),s.gravity&&(s.direction.y-=s.gravity),s.life--,t.push(s))}return t}))})),e(((e,t)=>{if(!o.current)return;const{forward:s,backward:r,left:n,right:a,up:c,down:d,strafeLeft:h,strafeRight:u,shift:m}=O(),p=o.current.rotation.y,x=new f(-Math.sin(p),0,-Math.cos(p)),g=new f(Math.cos(p),0,-Math.sin(p));if(s&&i.current.add(x.clone().multiplyScalar(.12)),r&&(i.current.add(x.clone().multiplyScalar(-.06)),i.current.y+=.012),n&&(o.current.rotation.y=E.lerp(o.current.rotation.y,o.current.rotation.y+.12,.2)),a&&(o.current.rotation.y=E.lerp(o.current.rotation.y,o.current.rotation.y-.12,.2)),h&&i.current.add(g.clone().multiplyScalar(-.05)),u&&i.current.add(g.clone().multiplyScalar(.05)),c)i.current.y+=B;else if(d){const e=m?.06:B;i.current.y-=e}else i.current.y-=.003;i.current.multiplyScalar(.97);i.current.length()>1&&i.current.normalize().multiplyScalar(1),o.current.position.add(i.current),o.current.position.y<1&&(o.current.position.y=1,i.current.y=0);let j=0,M=0;s&&(j=-.3),r&&(j=.3),h&&(M=.2),u&&(M=-.2);const w=o.current.rotation.y,b=new I;b.setFromEuler(o.current.rotation);const v=new y(j,w,M,"YXZ"),S=new I;S.setFromEuler(v);const k=(new I).copy(b);k.slerp(S,.1),o.current.setRotationFromQuaternion(k);const D=new f(o.current.position.x,o.current.position.y,o.current.position.z);if(L)F.position.set(o.current.position.x,o.current.position.y-3,o.current.position.z),F.lookAt(o.current.position.x,0,o.current.position.z);else{const e=new f(20*Math.sin(p),9,20*Math.cos(p));F.position.copy(D).add(e),F.lookAt(o.current.position.x,o.current.position.y+.1,o.current.position.z)}l([o.current.position.x,o.current.position.y,o.current.position.z])})),t.jsxs(t.Fragment,{children:[t.jsxs("group",{ref:o,position:c,children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[0,0,0],children:[t.jsx("cylinderGeometry",{args:[.6,.6,.2,6]}),t.jsx("meshStandardMaterial",{color:"#4a00e0",metalness:.8,roughness:.1})]}),[...Array(6)].map(((e,s)=>{const o=Math.PI*s/3;return t.jsx("group",{children:t.jsxs("group",{rotation:[0,o,0],children:[t.jsxs("mesh",{castShadow:!0,position:[.75,0,0],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.04,.04,1.5,8]}),t.jsx("meshStandardMaterial",{color:"#121212",metalness:.6,roughness:.3})]}),t.jsx("group",{position:[1.5,0,0],children:t.jsx(tt,{position:[0,0,0],index:s,propRef:e=>n.current[s]=e,active:d,speed:u,counterClockwise:s%2==1,scale:.75},`motor-${s}`)})]})},s)})),t.jsxs("group",{position:[.5,-.2,0],rotation:[0,Math.PI/2,0],children:[t.jsxs("mesh",{castShadow:!0,position:[0,-.2,0],children:[t.jsx("cylinderGeometry",{args:[.05,.05,.4,8]}),t.jsx("meshStandardMaterial",{color:"#64748b",metalness:.6,roughness:.4})]}),t.jsxs("mesh",{castShadow:!0,position:[0,-.4,0],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.04,.04,.8,8]}),t.jsx("meshStandardMaterial",{color:"#475569",metalness:.5,roughness:.5})]}),t.jsxs("mesh",{castShadow:!0,position:[-.35,-.3,0],rotation:[0,0,Math.PI/6],children:[t.jsx("cylinderGeometry",{args:[.03,.03,.3,8]}),t.jsx("meshStandardMaterial",{color:"#64748b",metalness:.6,roughness:.4})]}),t.jsxs("mesh",{castShadow:!0,position:[.35,-.3,0],rotation:[0,0,-Math.PI/6],children:[t.jsx("cylinderGeometry",{args:[.03,.03,.3,8]}),t.jsx("meshStandardMaterial",{color:"#64748b",metalness:.6,roughness:.4})]}),t.jsxs("mesh",{castShadow:!0,position:[-.4,-.45,0],children:[t.jsx("sphereGeometry",{args:[.06,8,8]}),t.jsx("meshStandardMaterial",{color:"#475569",metalness:.4,roughness:.6})]}),t.jsxs("mesh",{castShadow:!0,position:[.4,-.45,0],children:[t.jsx("sphereGeometry",{args:[.06,8,8]}),t.jsx("meshStandardMaterial",{color:"#475569",metalness:.4,roughness:.6})]})]}),t.jsxs("group",{position:[-.5,-.2,0],rotation:[0,-Math.PI/2,0],children:[t.jsxs("mesh",{castShadow:!0,position:[0,-.2,0],children:[t.jsx("cylinderGeometry",{args:[.05,.05,.4,8]}),t.jsx("meshStandardMaterial",{color:"#64748b",metalness:.6,roughness:.4})]}),t.jsxs("mesh",{castShadow:!0,position:[0,-.4,0],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.04,.04,.8,8]}),t.jsx("meshStandardMaterial",{color:"#475569",metalness:.5,roughness:.5})]}),t.jsxs("mesh",{castShadow:!0,position:[-.35,-.3,0],rotation:[0,0,Math.PI/6],children:[t.jsx("cylinderGeometry",{args:[.03,.03,.3,8]}),t.jsx("meshStandardMaterial",{color:"#64748b",metalness:.6,roughness:.4})]}),t.jsxs("mesh",{castShadow:!0,position:[.35,-.3,0],rotation:[0,0,-Math.PI/6],children:[t.jsx("cylinderGeometry",{args:[.03,.03,.3,8]}),t.jsx("meshStandardMaterial",{color:"#64748b",metalness:.6,roughness:.4})]}),t.jsxs("mesh",{castShadow:!0,position:[-.4,-.45,0],children:[t.jsx("sphereGeometry",{args:[.06,8,8]}),t.jsx("meshStandardMaterial",{color:"#475569",metalness:.4,roughness:.6})]}),t.jsxs("mesh",{castShadow:!0,position:[.4,-.45,0],children:[t.jsx("sphereGeometry",{args:[.06,8,8]}),t.jsx("meshStandardMaterial",{color:"#475569",metalness:.4,roughness:.6})]})]}),t.jsxs("group",{position:[0,-.3,0],children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.5,.5,.2,12]}),t.jsx("meshStandardMaterial",{color:"#3d3d3d",metalness:.8,roughness:.3})]}),[...Array(3)].map(((e,s)=>t.jsxs("mesh",{position:[.25*Math.sin(2*Math.PI*s/3),-.1,.25*Math.cos(2*Math.PI*s/3)],castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.15,.15,.05,12]}),t.jsx("meshStandardMaterial",{color:"#151515",metalness:.7,roughness:.3})]},s)))]}),t.jsxs("group",{position:[-.4,.2,0],children:[[...Array(5)].map(((e,s)=>t.jsxs("mesh",{position:[0,.15*(s-2),0],rotation:[0,0,Math.PI/2],castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.08,.1,.3,8]}),t.jsx("meshStandardMaterial",{color:"#3a3a3a",metalness:.7,roughness:.4})]},s))),[...Array(5)].map(((e,s)=>t.jsxs("mesh",{position:[-.2,.15*(s-2),0],rotation:[0,0,Math.PI/2],castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.06,.08,.15,8]}),t.jsx("meshStandardMaterial",{color:"#626262",metalness:.7,roughness:.3})]},s)))]}),t.jsxs("group",{position:[.4,.2,0],children:[[...Array(4)].map(((e,s)=>t.jsxs("mesh",{position:[0,.18*(s-1.5),0],rotation:[0,0,-Math.PI/2],castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.1,.12,.4,8]}),t.jsx("meshStandardMaterial",{color:"#3a3a3a",metalness:.7,roughness:.4})]},s))),[...Array(4)].map(((e,s)=>t.jsxs("mesh",{position:[.25,.18*(s-1.5),0],rotation:[0,0,-Math.PI/2],castShadow:!0,receiveShadow:!0,children:[t.jsx("coneGeometry",{args:[.1,.3,8]}),t.jsx("meshStandardMaterial",{color:"#626262",metalness:.7,roughness:.3})]},s)))]})]}),t.jsx(et,{projectiles:P})]})}function et({projectiles:e}){const s=r.useMemo((()=>({[ie.ANTI_TANK_MINE]:new h(.2,6,6),[ie.MORTAR]:new h(.15,6,6),[ie.RPG]:new h(.15,6,6)})),[]),o=r.useMemo((()=>({[ie.ANTI_TANK_MINE]:new v({color:"darkred"}),[ie.MORTAR]:new v({color:"gray"}),[ie.RPG]:new v({color:"darkgreen"})})),[]),i=k.memo((({projectile:e})=>t.jsx("mesh",{position:[e.position.x,e.position.y,e.position.z],geometry:s[e.type],material:o[e.type]})));return t.jsx(t.Fragment,{children:e.map((e=>t.jsx(i,{projectile:e},e.id)))})}function tt({position:s,index:o,propRef:i,active:n=!0,speed:a=1,counterClockwise:c=!1,scale:l=1}){r.useRef();const d=r.useRef(),h=c?-1:1;return e((()=>{d.current&&n&&(d.current.rotation.y+=.5*a*h),i&&i(d.current)})),t.jsxs("group",{position:s,scale:l,children:[t.jsxs("mesh",{castShadow:!0,receiveShadow:!0,children:[t.jsx("cylinderGeometry",{args:[.15,.18,.2,12]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.7,roughness:.3})]}),t.jsxs("mesh",{castShadow:!0,position:[0,.12,0],children:[t.jsx("cylinderGeometry",{args:[.12,.12,.05,12]}),t.jsx("meshStandardMaterial",{color:"#8d99ae",metalness:.8,roughness:.2})]}),t.jsxs("group",{ref:d,position:[0,.15,0],children:[t.jsxs("mesh",{castShadow:!0,children:[t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.5,roughness:.6}),t.jsxs("bufferGeometry",{children:[t.jsx("bufferAttribute",{attach:"attributes-position",count:12,itemSize:3,array:new Float32Array([0,0,0,.45,.015,-.075,.45,-.015,.075,0,0,0,.45,-.015,.075,.9,0,0,0,0,0,.9,0,0,.45,.015,-.075,.45,.015,-.075,.9,0,0,.45,-.015,.075])}),t.jsx("bufferAttribute",{attach:"attributes-normal",count:12,itemSize:3,array:new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0])})]})]}),t.jsxs("mesh",{castShadow:!0,rotation:[0,Math.PI,0],children:[t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.5,roughness:.6}),t.jsxs("bufferGeometry",{children:[t.jsx("bufferAttribute",{attach:"attributes-position",count:12,itemSize:3,array:new Float32Array([0,0,0,.45,.015,-.075,.45,-.015,.075,0,0,0,.45,-.015,.075,.9,0,0,0,0,0,.9,0,0,.45,.015,-.075,.45,.015,-.075,.9,0,0,.45,-.015,.075])}),t.jsx("bufferAttribute",{attach:"attributes-normal",count:12,itemSize:3,array:new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0])})]})]}),t.jsxs("mesh",{children:[t.jsx("sphereGeometry",{args:[.06,8,8]}),t.jsx("meshStandardMaterial",{color:"#2b2d42",metalness:.7,roughness:.2})]})]})]})}function st(){const{currentDrone:e}=J();switch(e){case q:return t.jsx(qe,{});case Z:return t.jsx(Je,{});default:return t.jsx(Ue,{})}}const ot=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.2,0],children:[t.jsx("boxGeometry",{args:[2,.4,3]}),t.jsx("meshStandardMaterial",{color:"olive"})]}),t.jsxs("mesh",{position:[1.3,.1,0],children:[t.jsx("boxGeometry",{args:[.6,.2,3]}),t.jsx("meshStandardMaterial",{color:"darkgreen"})]}),t.jsxs("mesh",{position:[-1.3,.1,0],children:[t.jsx("boxGeometry",{args:[.6,.2,3]}),t.jsx("meshStandardMaterial",{color:"darkgreen"})]}),[1.2,.4,-.4,-1.2].map(((e,s)=>t.jsxs("mesh",{position:[1.3,.1,e],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.2,.2,.6,16]}),t.jsx("meshStandardMaterial",{color:"gray"})]},s))),[1.2,.4,-.4,-1.2].map(((e,s)=>t.jsxs("mesh",{position:[-1.3,.1,e],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.2,.2,.6,16]}),t.jsx("meshStandardMaterial",{color:"gray"})]},s+4))),t.jsxs("mesh",{position:[0,.6,0],children:[t.jsx("cylinderGeometry",{args:[.5,.5,.8,32]}),t.jsx("meshStandardMaterial",{color:"darkgreen"})]}),t.jsxs("mesh",{position:[0,1,0],children:[t.jsx("boxGeometry",{args:[.4,.1,.4]}),t.jsx("meshStandardMaterial",{color:"green"})]}),t.jsxs("mesh",{position:[0,.6,-.4],rotation:[Math.PI/2,0,0],children:[t.jsx("cylinderGeometry",{args:[.05,.05,1.2,16]}),t.jsx("meshStandardMaterial",{color:"gray"})]}),t.jsxs("mesh",{position:[0,.6,-1],rotation:[Math.PI/2,0,0],children:[t.jsx("cylinderGeometry",{args:[.07,.07,.1,16]}),t.jsx("meshStandardMaterial",{color:"gray"})]}),t.jsxs("mesh",{position:[0,.3,1.5],children:[t.jsx("cylinderGeometry",{args:[.1,.1,.3,16]}),t.jsx("meshStandardMaterial",{color:"gray"})]}),t.jsxs("mesh",{position:[1,.3,-1.5],children:[t.jsx("boxGeometry",{args:[.2,.2,.2]}),t.jsx("meshStandardMaterial",{color:"yellow"})]}),t.jsxs("mesh",{position:[-1,.3,-1.5],children:[t.jsx("boxGeometry",{args:[.2,.2,.2]}),t.jsx("meshStandardMaterial",{color:"yellow"})]})]}),rt=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.55,0],children:[t.jsx("boxGeometry",{args:[3.2,1.1,5.2]}),t.jsx("meshStandardMaterial",{color:"#4B5320"})]}),t.jsxs("mesh",{position:[0,1.1,0],children:[t.jsx("boxGeometry",{args:[3.4,.2,5.4]}),t.jsx("meshStandardMaterial",{color:"#556B2F"})]}),t.jsxs("group",{position:[0,1.2,.4],children:[t.jsxs("mesh",{position:[0,0,0],children:[t.jsx("boxGeometry",{args:[2,.6,2.5]}),t.jsx("meshStandardMaterial",{color:"#6B8E23"})]}),t.jsxs("mesh",{position:[0,0,-1.25],rotation:[Math.PI/2,0,0],children:[t.jsx("cylinderGeometry",{args:[.2,.2,4,32]}),t.jsx("meshStandardMaterial",{color:"#A9A9A9"})]})]}),[-1.8,1.8].map(((e,s)=>t.jsxs("group",{position:[e,.2,0],children:[[1.9,.9,-.1,-1.1].map(((e,s)=>t.jsxs("mesh",{position:[0,0,e],children:[t.jsx("boxGeometry",{args:[.5,.25,1.1]}),t.jsx("meshStandardMaterial",{color:"#3B3B3B"})]},s))),[1.5,.5,-.5,-1.5].map(((e,o)=>t.jsxs("mesh",{position:[0,-.35,e],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.35,.35,.25,32]}),t.jsx("meshStandardMaterial",{color:"#222"})]},`wheel-${s}-${o}`)))]},s)))]}),it=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.2,0],children:[t.jsx("boxGeometry",{args:[2,.4,4]}),t.jsx("meshStandardMaterial",{color:"slategray"})]}),t.jsxs("mesh",{position:[1.3,.1,0],children:[t.jsx("boxGeometry",{args:[.6,.2,4]}),t.jsx("meshStandardMaterial",{color:"dimgray"})]}),t.jsxs("mesh",{position:[-1.3,.1,0],children:[t.jsx("boxGeometry",{args:[.6,.2,4]}),t.jsx("meshStandardMaterial",{color:"dimgray"})]}),[-1.6,-.8,0,.8,1.6].map(((e,s)=>t.jsxs("mesh",{position:[1.3,.1,e],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.25,.25,.6,16]}),t.jsx("meshStandardMaterial",{color:"gray"})]},s))),[-1.6,-.8,0,.8,1.6].map(((e,s)=>t.jsxs("mesh",{position:[-1.3,.1,e],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.25,.25,.6,16]}),t.jsx("meshStandardMaterial",{color:"gray"})]},s+5))),t.jsxs("mesh",{position:[0,.6,-.5],children:[t.jsx("boxGeometry",{args:[.8,.3,1]}),t.jsx("meshStandardMaterial",{color:"dimgray"})]}),t.jsxs("mesh",{position:[0,.6,-1],rotation:[Math.PI/2,0,0],children:[t.jsx("cylinderGeometry",{args:[.08,.08,1.5,16]}),t.jsx("meshStandardMaterial",{color:"gray"})]})]}),nt=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.3,0],children:[t.jsx("boxGeometry",{args:[2.2,.5,4.2]}),t.jsx("meshStandardMaterial",{color:"#505050"})]}),t.jsxs("mesh",{position:[0,.7,.4],children:[t.jsx("boxGeometry",{args:[2,.3,3]}),t.jsx("meshStandardMaterial",{color:"#606060"})]}),t.jsxs("mesh",{position:[1.3,.15,0],children:[t.jsx("boxGeometry",{args:[.6,.3,4.2]}),t.jsx("meshStandardMaterial",{color:"#333333"})]}),t.jsxs("mesh",{position:[-1.3,.15,0],children:[t.jsx("boxGeometry",{args:[.6,.3,4.2]}),t.jsx("meshStandardMaterial",{color:"#333333"})]}),[-1.8,-1.2,-.6,0,.6,1.2,1.8].map(((e,s)=>t.jsxs("mesh",{position:[1.3,.15,e],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.22,.22,.6,16]}),t.jsx("meshStandardMaterial",{color:"#222222"})]},s))),[-1.8,-1.2,-.6,0,.6,1.2,1.8].map(((e,s)=>t.jsxs("mesh",{position:[-1.3,.15,e],rotation:[0,0,Math.PI/2],children:[t.jsx("cylinderGeometry",{args:[.22,.22,.6,16]}),t.jsx("meshStandardMaterial",{color:"#222222"})]},s+7))),t.jsxs("mesh",{position:[0,.9,-.8],children:[t.jsx("boxGeometry",{args:[1.6,.2,1.6]}),t.jsx("meshStandardMaterial",{color:"#707070"})]}),t.jsxs("mesh",{position:[0,1.1,-.8],children:[t.jsx("boxGeometry",{args:[1.2,.3,1.2]}),t.jsx("meshStandardMaterial",{color:"#808080"})]}),t.jsxs("mesh",{position:[0,1.1,-1.4],rotation:[Math.PI/2,0,0],children:[t.jsx("cylinderGeometry",{args:[.1,.1,2,16]}),t.jsx("meshStandardMaterial",{color:"#909090"})]}),t.jsxs("mesh",{position:[.5,1.3,-.8],rotation:[0,0,0],children:[t.jsx("cylinderGeometry",{args:[.05,.05,.6,16]}),t.jsx("meshStandardMaterial",{color:"#A0A0A0"})]}),t.jsxs("mesh",{position:[-.8,1.3,-.8],rotation:[.1,0,0],children:[t.jsx("cylinderGeometry",{args:[.02,.01,.8,8]}),t.jsx("meshStandardMaterial",{color:"#202020"})]}),t.jsxs("mesh",{position:[0,.5,2],rotation:[Math.PI/6,0,0],children:[t.jsx("boxGeometry",{args:[2.2,.4,.6]}),t.jsx("meshStandardMaterial",{color:"#606060"})]}),t.jsxs("mesh",{position:[0,.5,-1.8],children:[t.jsx("boxGeometry",{args:[2,.5,.6]}),t.jsx("meshStandardMaterial",{color:"#404040"})]}),t.jsxs("mesh",{position:[.8,.4,2.2],children:[t.jsx("boxGeometry",{args:[.2,.2,.1]}),t.jsx("meshStandardMaterial",{color:"#FFFF00"})]}),t.jsxs("mesh",{position:[-.8,.4,2.2],children:[t.jsx("boxGeometry",{args:[.2,.2,.1]}),t.jsx("meshStandardMaterial",{color:"#FFFF00"})]})]}),at=e=>t.jsxs("group",{...e,children:[t.jsxs("group",{position:[-.8,.7,-1],children:[t.jsxs("mesh",{children:[t.jsx("boxGeometry",{args:[1.6,1.2,1.8]}),t.jsx("meshStandardMaterial",{color:"#1E90FF"})]}),t.jsxs("mesh",{position:[0,.2,.95],children:[t.jsx("boxGeometry",{args:[1.4,.5,.1]}),t.jsx("meshStandardMaterial",{color:"#87CEEB",transparent:!0,opacity:.7})]})]}),t.jsxs("group",{position:[1,.7,1],children:[t.jsxs("mesh",{children:[t.jsx("boxGeometry",{args:[3,1.2,4]}),t.jsx("meshStandardMaterial",{color:"#ADD8E6"})]}),t.jsxs("mesh",{position:[0,.8,1.8],children:[t.jsx("boxGeometry",{args:[2.8,.4,.1]}),t.jsx("meshStandardMaterial",{color:"#ccc"})]})]}),[{pos:[-1.4,.3,-1.2]},{pos:[-1.4,.3,0]},{pos:[2.2,.3,1]},{pos:[2.2,.3,2]}].map(((e,s)=>t.jsxs("mesh",{position:e.pos,children:[t.jsx("cylinderGeometry",{args:[.45,.45,.3,16]}),t.jsx("meshStandardMaterial",{color:"#222"})]},s)))]}),ct=e=>t.jsxs("group",{...e,children:[t.jsxs("group",{position:[-.5,.75,-1],children:[t.jsxs("mesh",{children:[t.jsx("boxGeometry",{args:[1.4,1.3,1.6]}),t.jsx("meshStandardMaterial",{color:"#DC143C"})]}),t.jsxs("mesh",{position:[0,.3,.9],children:[t.jsx("boxGeometry",{args:[1.2,.4,.1]}),t.jsx("meshStandardMaterial",{color:"#FFA07A",transparent:!0,opacity:.7})]})]}),t.jsxs("group",{position:[.5,.75,1],children:[t.jsxs("mesh",{children:[t.jsx("boxGeometry",{args:[3.2,1.3,4.2]}),t.jsx("meshStandardMaterial",{color:"#FFC0CB"})]}),t.jsxs("mesh",{position:[0,.8,1.9],children:[t.jsx("boxGeometry",{args:[3,.3,.1]}),t.jsx("meshStandardMaterial",{color:"#ddd"})]})]}),[{pos:[-1.1,.3,-1.3]},{pos:[-1.1,.3,-.1]},{pos:[1.8,.3,1.2]},{pos:[1.8,.3,2.2]}].map(((e,s)=>t.jsxs("mesh",{position:e.pos,children:[t.jsx("cylinderGeometry",{args:[.4,.4,.3,16]}),t.jsx("meshStandardMaterial",{color:"#222"})]},s)))]}),lt=e=>t.jsxs("group",{...e,children:[t.jsxs("group",{position:[-.6,.65,-1],children:[t.jsxs("mesh",{children:[t.jsx("boxGeometry",{args:[1.8,1.1,1.7]}),t.jsx("meshStandardMaterial",{color:"#228B22"})]}),t.jsxs("mesh",{position:[0,.4,.85],children:[t.jsx("boxGeometry",{args:[1.6,.2,.1]}),t.jsx("meshStandardMaterial",{color:"#ADFF2F"})]})]}),t.jsxs("group",{position:[.4,.65,1],children:[t.jsxs("mesh",{children:[t.jsx("boxGeometry",{args:[3.4,1.1,4]}),t.jsx("meshStandardMaterial",{color:"#90EE90"})]}),t.jsxs("mesh",{position:[0,.75,1.8],children:[t.jsx("boxGeometry",{args:[3.2,.3,.1]}),t.jsx("meshStandardMaterial",{color:"#ccc"})]})]}),[{pos:[-1.3,.3,-1.4]},{pos:[-1.3,.3,-.2]},{pos:[2,.3,1.3]},{pos:[2,.3,2.3]}].map(((e,s)=>t.jsxs("mesh",{position:e.pos,children:[t.jsx("cylinderGeometry",{args:[.45,.45,.35,16]}),t.jsx("meshStandardMaterial",{color:"#222"})]},s)))]}),dt=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.65,0],children:[t.jsx("boxGeometry",{args:[3,1.4,5]}),t.jsx("meshStandardMaterial",{color:"#556B2F"})]}),t.jsxs("mesh",{position:[0,1.15,0],children:[t.jsx("boxGeometry",{args:[3.2,.3,5.2]}),t.jsx("meshStandardMaterial",{color:"#6B8E23"})]}),t.jsxs("mesh",{position:[-1,1.3,-1.8],children:[t.jsx("boxGeometry",{args:[1.2,.8,1.5]}),t.jsx("meshStandardMaterial",{color:"#8B4513"})]}),[{pos:[-1.5,.2,-1.8]},{pos:[-1.5,.2,0]},{pos:[1.5,.2,1.8]},{pos:[1.5,.2,0]}].map(((e,s)=>t.jsxs("mesh",{position:e.pos,children:[t.jsx("cylinderGeometry",{args:[.5,.5,.3,16]}),t.jsx("meshStandardMaterial",{color:"#222"})]},s)))]}),ht=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.6,0],children:[t.jsx("boxGeometry",{args:[3.4,1.3,5.5]}),t.jsx("meshStandardMaterial",{color:"#8B4513"})]}),t.jsxs("mesh",{position:[0,1.05,0],children:[t.jsx("boxGeometry",{args:[3.6,.3,5.7]}),t.jsx("meshStandardMaterial",{color:"#A0522D"})]}),t.jsxs("mesh",{position:[1.2,1.1,1.8],children:[t.jsx("boxGeometry",{args:[1.2,.8,2]}),t.jsx("meshStandardMaterial",{color:"#CD853F"})]}),[{pos:[-1.7,.2,-2]},{pos:[-1.7,.2,0]},{pos:[1.7,.2,2]},{pos:[1.7,.2,0]}].map(((e,s)=>t.jsxs("mesh",{position:e.pos,children:[t.jsx("cylinderGeometry",{args:[.55,.55,.35,16]}),t.jsx("meshStandardMaterial",{color:"#222"})]},s)))]}),ut=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.65,0],children:[t.jsx("boxGeometry",{args:[3.2,1.2,5]}),t.jsx("meshStandardMaterial",{color:"#2F4F4F"})]}),t.jsxs("mesh",{position:[0,1.1,0],children:[t.jsx("boxGeometry",{args:[3.4,.3,5.2]}),t.jsx("meshStandardMaterial",{color:"#708090"})]}),t.jsxs("mesh",{position:[0,1.3,-1.5],children:[t.jsx("boxGeometry",{args:[1,.3,1.8]}),t.jsx("meshStandardMaterial",{color:"#696969"})]}),[{pos:[-1.6,.2,-1.8]},{pos:[-1.6,.2,0]},{pos:[1.6,.2,1.8]},{pos:[1.6,.2,0]}].map(((e,s)=>t.jsxs("mesh",{position:e.pos,children:[t.jsx("cylinderGeometry",{args:[.5,.5,.35,16]}),t.jsx("meshStandardMaterial",{color:"#222"})]},s)))]}),mt=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.45,0],children:[t.jsx("boxGeometry",{args:[2,.9,4]}),t.jsx("meshStandardMaterial",{color:"#C0C0C0"})]}),t.jsxs("mesh",{position:[0,.6,-1.9],children:[t.jsx("boxGeometry",{args:[1.8,.2,.1]}),t.jsx("meshStandardMaterial",{color:"#333"})]}),[-.8,.8].map(((e,s)=>t.jsxs("mesh",{position:[e,.6,-2],children:[t.jsx("sphereGeometry",{args:[.15,16,16]}),t.jsx("meshStandardMaterial",{color:"#FFFFE0",emissive:"#FFFF66"})]},`hl-${s}`))),[-.9,.9].map(((e,s)=>[-1,1].map(((o,r)=>t.jsxs("mesh",{position:[e,.2,1.6*o],children:[t.jsx("cylinderGeometry",{args:[.4,.4,.3,24]}),t.jsx("meshStandardMaterial",{color:"#222"})]},`${s}-${r}`)))))]}),pt=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.5,0],children:[t.jsx("boxGeometry",{args:[2.2,1,4.2]}),t.jsx("meshStandardMaterial",{color:"#FFFFFF"})]}),t.jsxs("mesh",{position:[0,.9,0],children:[t.jsx("boxGeometry",{args:[2,.1,.1]}),t.jsx("meshStandardMaterial",{color:"#FF4500"})]}),[-1.1,1.1].map(((e,s)=>[-1,1].map(((o,r)=>t.jsxs("mesh",{position:[e,.2,1.8*o],children:[t.jsx("cylinderGeometry",{args:[.45,.45,.35,24]}),t.jsx("meshStandardMaterial",{color:"#222"})]},`${s}-${r}`))))),[-.8,.8].map(((e,s)=>t.jsxs("mesh",{position:[e,.65,-2.1],children:[t.jsx("sphereGeometry",{args:[.15,16,16]}),t.jsx("meshStandardMaterial",{color:"#FFFFE0",emissive:"#FFFF66"})]},`hlb-${s}`)))]}),xt=e=>t.jsxs("group",{...e,children:[t.jsxs("mesh",{position:[0,.45,0],children:[t.jsx("boxGeometry",{args:[1.8,.8,3.8]}),t.jsx("meshStandardMaterial",{color:"#FFD700"})]}),t.jsxs("mesh",{position:[0,.4,-1.95],children:[t.jsx("boxGeometry",{args:[1.6,.1,.3]}),t.jsx("meshStandardMaterial",{color:"#333"})]}),t.jsxs("mesh",{position:[0,.8,1.9],rotation:[-.2,0,0],children:[t.jsx("boxGeometry",{args:[1,.1,.4]}),t.jsx("meshStandardMaterial",{color:"#333"})]}),[-.8,.8].map(((e,s)=>[-1,1].map(((o,r)=>t.jsxs("mesh",{position:[e,.2,1.5*o],children:[t.jsx("cylinderGeometry",{args:[.4,.4,.3,24]}),t.jsx("meshStandardMaterial",{color:"#222"})]},`${s}-${r}`))))),[-.6,.6].map(((e,s)=>t.jsxs("mesh",{position:[e,.65,-2],children:[t.jsx("sphereGeometry",{args:[.15,16,16]}),t.jsx("meshStandardMaterial",{color:"#FFFFE0",emissive:"#FFFF66"})]},`hlc-${s}`)))]}),ft={tank_a:ot,tank_b:rt,ifv_a:it,ifv_b:nt,civilian_truck_1:at,civilian_truck_2:ct,civilian_truck_3:lt,military_truck_1:dt,military_truck_2:ht,military_truck_3:ut,car_a:mt,car_b:pt,car_c:xt},yt=(e,s)=>k.forwardRef(((o,i)=>{const{id:n,...a}=o,{initVehicle:c,getVehicleHealth:l}=se(),d=n||`vehicle-${s}-${Math.floor(1e4*Math.random())}`;r.useEffect((()=>{c(d,s)}),[d,s]);const h=l(d);if(!h)return t.jsx(e,{...a,ref:i});if(h.isDestroyed)return null;const u={...a};if(h.isDead){if(u.position){const[e,t,s]=u.position;u.position=[e,t-.15,s]}if(u.rotation){const[e,t,s]=u.rotation;u.rotation=[e+(.2*Math.random()-.1),t,s+(.2*Math.random()-.1)]}}return t.jsx("group",{ref:i,children:t.jsx(e,{...u,userData:{vehicleId:d,vehicleType:s,health:h.currentHealth,maxHealth:h.maxHealth,isDead:h.isDead,isDestroyed:h.isDestroyed,mobilityFactor:h.mobilityFactor,canMove:h.healthPercentage>.5}})})})),gt={tank_a:yt(ot,"tank_a"),tank_b:yt(rt,"tank_b"),ifv_a:yt(it,"ifv_a"),ifv_b:yt(nt,"ifv_b"),civilian_truck_1:yt(at,"civilian_truck_1"),civilian_truck_2:yt(ct,"civilian_truck_2"),civilian_truck_3:yt(lt,"civilian_truck_3"),military_truck_1:yt(dt,"military_truck_1"),military_truck_2:yt(ht,"military_truck_2"),military_truck_3:yt(ut,"military_truck_3"),car_a:yt(mt,"car_a"),car_b:yt(pt,"car_b"),car_c:yt(xt,"car_c")},jt=.18,Mt="fast",wt="slow",bt=40,vt=Math.max(18,bt),St=1*vt,kt=.6*vt,It=5e3,Et=[{id:"combo1",vehicles:[{type:"tank",count:3},{type:"ifv",count:2},{type:"military_truck",count:1}]},{id:"combo2",vehicles:[{type:"tank",count:1},{type:"ifv",count:3},{type:"military_truck",count:2}]},{id:"combo3",vehicles:[{type:"tank",count:2},{type:"ifv",count:2},{type:"military_truck",count:2}]},{id:"combo4",vehicles:[{type:"tank",count:1},{type:"ifv",count:4},{type:"military_truck",count:1}]}];function Dt(e){return e[Math.floor(Math.random()*e.length)]}function Rt(e){const t=Object.keys(ft);let s=[];return"tank"===e?s=t.filter((e=>e.includes("tank_"))):"ifv"===e?s=t.filter((e=>e.includes("ifv_"))):"military_truck"===e?s=t.filter((e=>e.includes("military_truck_"))):"car"===e?s=t.filter((e=>e.includes("car_"))):"civilian_truck"===e&&(s=t.filter((e=>e.includes("civilian_truck_")))),s.length>0?Dt(s):null}function Gt(){const[s,o]=r.useState([]),i=r.useRef(!1),n=r.useRef({}),a=se(),c=a.getVehicleHealth;function l(e,t,s=vt){const o=t.filter((t=>t.id!==e.id&&Math.abs(t.lane-e.lane)<.5&&Math.abs(t.road-e.road)<.5));let r=1/0,i=!1;return o.forEach((t=>{if(e.direction>0&&t.direction>0){if(t.position.x>e.position.x){const o=t.position.x-e.position.x;o<s&&(i=!0,r=Math.min(r,o))}}else if(e.direction<0&&t.direction<0&&t.position.x<e.position.x){const o=e.position.x-t.position.x;o<s&&(i=!0,r=Math.min(r,o))}})),e.distanceToNext=i?r:1/0,i}function d(e,t){const s=[],o=Dt(Et),r=`column-${Math.random().toString(36).substring(2,9)}`,i=t>0?-900:900,n=Math.abs(e)<H?-150:150;let a=i,c=0;for(const l of o.vehicles)for(let o=0;o<l.count;o++){const i=Rt(l.type);if(!i)continue;const d=`${r}-${l.type}-${o}`;s.push({id:d,type:i,columnId:r,columnPosition:c,position:new f(a,.3,e+(.2*Math.random()-.1)),rotation:new y(0,t>0?-Math.PI/2:Math.PI/2,0),speed:jt+.07*Math.random()*.5,direction:t,lane:e,road:n,laneType:Mt,isInColumn:!0,hitbox:{width:1,height:1,depth:3}}),a+=30*t,c++}return s}return r.useEffect((()=>{if(i.current)return;i.current=!0;const e=[];[-150,150].forEach((t=>{const s=[{z:t-30,direction:-1,type:Mt},{z:t-10,direction:-1,type:wt},{z:t+10,direction:1,type:wt},{z:t+30,direction:1,type:Mt}],o=s.filter((e=>e.type===Mt)),r=s.filter((e=>e.type===wt));o.forEach((s=>{const o=Dt(Et),r=`column-${t}-${s.z}`;let i=s.direction>0?-900:900,n=0;for(const a of o.vehicles)for(let o=0;o<a.count;o++){const c=Rt(a.type);if(!c)continue;const l=`${r}-${a.type}-${o}`;e.push({id:l,type:c,columnId:r,columnPosition:n,position:new f(i,.3,s.z+(.2*Math.random()-.1)),rotation:new y(0,s.direction>0?-Math.PI/2:Math.PI/2,0),speed:jt+.07*Math.random()*.5,direction:s.direction,lane:s.z,road:t,laneType:s.type,isInColumn:!0,hitbox:{width:1,height:1,depth:3}}),i+=30*s.direction,n++}})),r.forEach((s=>{for(let o=0;o<8;o++){const r=Math.random()<.7?Rt("car"):Rt("civilian_truck");if(!r)continue;const i=250,n=60,a=Math.max(i,n),c=o*a-1e3+Math.random()*(.6*a),l=`vehicle-${t}-${s.z}-${o}`;e.push({id:l,type:r,position:new f(s.direction>0?c:-c,.3,s.z+(.2*Math.random()-.1)),rotation:new y(0,s.direction>0?-Math.PI/2:Math.PI/2,0),speed:jt+.07*Math.random(),direction:s.direction,lane:s.z,road:t,laneType:s.type,isInColumn:!1,hitbox:{width:1,height:1,depth:3}})}}))})),o(e)}),[]),e(((e,t)=>{o((e=>{const s=new Set,r=new Map,i=new Map,h=new Map;e.forEach((e=>{if(e.isInColumn&&e.columnId){s.add(e.columnId);const t=c(e.id);t&&t.isDead&&(r.set(e.id,e),e.hasNotifiedColumn||h.set(e.columnId,Date.now()),e.clearingStarted||setTimeout((()=>{o((t=>{const s=Date.now(),o=e.columnId;return t.map((t=>t.id===e.id?{...t,clearingStarted:!0,clearingTime:s,hasNotifiedColumn:!0}:t.columnId===o?{...t,columnHasDestroyed:!0,lastDestroyedTime:s}:t))}))}),0),!e.markedForRemoval&&e.clearingStarted&&t.isDestroyed&&setTimeout((()=>{o((t=>t.map((t=>t.id===e.id?{...t,markedForRemoval:!0}:t))))}),It))}}));const u=e.filter((e=>{if(e.isInColumn){const t=c(e.id);if(t&&t.isDead&&t.isDestroyed&&e.markedForRemoval){const t=`${e.columnId}-${e.columnPosition}`;return i.set(t,{x:e.position.x,lane:e.lane,road:e.road,columnId:e.columnId,columnPosition:e.columnPosition,direction:e.direction,clearingTime:Date.now()}),setTimeout((()=>{o((t=>t.map((t=>t.columnId===e.columnId?{...t,columnHasRemoval:!0,lastRemovalTime:Date.now()}:t))))}),0),!1}}return!0})),m=new Map;u.forEach((e=>{e.isInColumn&&e.columnId&&(m.has(e.columnId)||m.set(e.columnId,[]),m.get(e.columnId).push(e))}));const p=u.map((e=>{if(e.isInColumn)return e;const s=c(e.id);if(s&&s.isDead)return e;const o=s?s.mobilityFactor:1,r=e.speed*o,i=l(e,u,kt),n=l(e,u,bt),a=l(e,u,St);let d=r;if(i)d=0;else if(n){const t=(e.distanceToNext-kt)/(bt-kt);d=r*Math.max(.05,.1*t)}else if(a){const t=(e.distanceToNext-bt)/(St-bt);d=r*Math.max(.3,t)}const h=Math.min(Math.abs(d-e.speed),.01),m=d>e.speed?e.speed+h:e.speed-h,p=e.position.x+m*e.direction*t*60;return e.direction>0&&p>1e3?{...e,position:new f(-1e3,.3,e.position.z),speed:e.speed}:e.direction<0&&p<-1e3?{...e,position:new f(1e3,.3,e.position.z),speed:e.speed}:{...e,position:new f(p,e.position.y,e.position.z),speed:m}}));m.forEach(((e,s)=>{if(e.sort(((e,t)=>e.columnPosition-t.columnPosition)),0===e.length)return;let r=0,a=e[r],h=c(a.id);for(;r<e.length-1&&h&&h.isDead;)r++,a=e[r],h=c(a.id);if(h&&h.isDead){let t=!1,s=-1;for(let o=0;o<e.length;o++){const r=c(e[o].id);if(!r||!r.isDead){s=o,t=!0;break}}if(!t)return;r=s,a=e[r],h=c(a.id)}const u=e.filter(((e,t)=>{if(t<r)return!1;const s=c(e.id);return!(s&&s.isDead)}));u.forEach(((e,t)=>{e.effectiveColumnPosition=t}));const m=c(a.id),x=m?m.mobilityFactor:1,y=a.speed*x,g=l(a,p,kt),j=l(a,p,bt),M=l(a,p,St);let w=y;if(g)w=0;else if(j){const e=(a.distanceToNext-kt)/(bt-kt);w=y*Math.max(.05,.1*e)}else if(M){const e=(a.distanceToNext-bt)/(St-bt);w=y*Math.max(.3,e)}const b=Math.min(Math.abs(w-a.speed),.01),v=w>a.speed?a.speed+b:a.speed-b,S=a.position.x+v*a.direction*t*60;a.direction>0&&S>1e3||a.direction<0&&S<-1e3?(e.forEach((e=>{const t=p.findIndex((t=>t.id===e.id));-1!==t&&(p[t]={...e,isRemoved:!0})})),function(e,t){const s=`${e}-${t}`;n.current[s]||(n.current[s]=setTimeout((()=>{n.current[s]=null,o((s=>[...s,...d(e,t)]))}),5e3))}(a.lane,a.direction)):e.forEach(((t,s)=>{const o=p.findIndex((e=>e.id===t.id));if(-1!==o){const n=c(t.id);if(n&&n.isDead)return;if(s===r)p[o]={...t,position:new f(S,t.position.y,t.position.z),speed:v};else if(s<r);else{const n=u.findIndex((e=>e.id===t.id));if(-1!==n){u[n].effectiveColumnPosition;let l=!1,d=null,h=!0;for(let o=0;o<s;o++){const s=e[o];if(o<r)continue;const i=c(s.id);if(i&&i.isDead){if(l=!0,s.clearingTime){Date.now()-s.clearingTime<It?h=!1:l=!1}else h=!1;h||(!d||t.direction>0&&s.position.x<d.x||t.direction<0&&s.position.x>d.x)&&(d=s.position)}}let m=!1,x=null;for(const[e,s]of i.entries())if(s.columnId===t.columnId&&s.columnPosition<t.columnPosition){Date.now()-s.clearingTime<It&&(m=!0,(!x||t.direction>0&&s.x<x||t.direction<0&&s.x>x)&&(x=s.x))}if(l&&d&&!h||m&&x)p[o]={...t,position:t.position,speed:0};else{const s=e.some((e=>{const t=c(e.id);return t&&t.isDead}));let r=!1;if(t.columnHasDestroyed&&t.lastDestroyedTime){r=Date.now()-t.lastDestroyedTime<It}if(s&&r)p[o]={...t,position:t.position,speed:0};else{const e=30,s=(t.columnPosition-a.columnPosition)*e,r=a.position.x-s*t.direction;p[o]={...t,position:new f(r,t.position.y,t.position.z),speed:v}}}}}}}))}));const x=p.filter((e=>!e.isRemoved)).map((e=>{if(e.isInColumn)return e;const t=c(e.id);if(t&&t.isDead&&t.isDestroyed){const t=e.direction>0?-1e3:1e3,s=p.filter((s=>s.id!==e.id&&s.direction===e.direction&&Math.abs(s.lane-e.lane)<.5&&Math.abs(s.road-e.road)<.5&&(e.direction>0&&s.position.x>t&&s.position.x<t+100||e.direction<0&&s.position.x<t&&s.position.x>t-100))).length>0?e.direction>0?-100:100:0,o={...e,position:new f(t+s,.3,e.position.z),speed:jt+.07*Math.random()};return setTimeout((()=>{a.respawnVehicle(e.id)}),0),o}return e})),y=[];return y.length>0&&x.push(...y),x}))})),t.jsx(t.Fragment,{children:s.map((e=>{c(e.id);const s=gt[e.type];return t.jsxs("group",{position:[e.position.x,e.position.y,e.position.z],rotation:[e.rotation.x,e.rotation.y,e.rotation.z],userData:{vehicleId:e.id,vehicleType:e.type,isVehicle:!0,isInColumn:e.isInColumn,columnId:e.columnId,hitbox:{width:3,height:1.5,depth:5}},name:`vehicle-${e.id}`,children:[t.jsx(s,{id:e.id,scale:[3,3,3],userData:{vehicleId:e.id,vehicleType:e.type,isVehicle:!0}}),!1]},e.id)}))})}const At=({onSelectVehicle:e})=>{const{scene:t,camera:o,gl:i,raycaster:n}=s();return r.useEffect((()=>{const s=s=>{const r=i.domElement.getBoundingClientRect(),a=(s.clientX-r.left)/r.width*2-1,c=-(s.clientY-r.top)/r.height*2+1;n.setFromCamera({x:a,y:c},o);const l=n.intersectObjects(t.children,!0);let d=!1;for(let t=0;t<l.length;t++){let s=l[t].object;for(;s;){if(s.userData&&s.userData.vehicleId){e(s.userData.vehicleId),d=!0;break}s=s.parent}if(d)break}},r=i.domElement;return r.addEventListener("click",s),()=>{r.removeEventListener("click",s)}}),[t,o,i,n,e]),null};function Tt({onSelectVehicle:e}){const{scene:o}=s();return r.useEffect((()=>{o.fog=new D("#b5d3e7",85e-5)}),[o]),o.background=o.background,t.jsxs(t.Fragment,{children:[t.jsx(A,{preset:"sunset"}),t.jsx(T,{distance:45e4,sunPosition:[0,1,0],inclination:.5,azimuth:.25}),t.jsx("directionalLight",{position:[50,50,25],intensity:1.5,"shadow-mapSize":[2048,2048],"shadow-camera-left":-1e3,"shadow-camera-right":1e3,"shadow-camera-top":1e3,"shadow-camera-bottom":-1e3,"shadow-camera-near":.1,"shadow-camera-far":2e3}),t.jsx("ambientLight",{intensity:.2}),t.jsx(L,{}),t.jsx(V,{}),t.jsx(Y,{}),t.jsx(Gt,{}),t.jsx(st,{}),t.jsx(Ne,{}),t.jsx(Ve,{}),t.jsx(Le,{}),t.jsx(At,{onSelectVehicle:e})]})}const zt="forward",Pt="backward",Ct="left",Ft="right",Nt="up",_t="down",Ot="strafeLeft",Lt="strafeRight";function Ht({children:e}){const s=[{name:zt,keys:["KeyW"]},{name:Pt,keys:["KeyS"]},{name:Ct,keys:["KeyQ"]},{name:Ft,keys:["KeyE"]},{name:Nt,keys:["Space"]},{name:_t,keys:["ShiftLeft"]},{name:Ot,keys:["KeyA"]},{name:Lt,keys:["KeyD"]}];return t.jsx(z,{map:s,children:e})}function $t(){const{currentDrone:e,switchDrone:s}=J();return t.jsxs("div",{className:"drone-selector",children:[t.jsx("div",{className:"selector-heading",children:"Select Drone"}),t.jsxs("div",{className:"selector-options",children:[t.jsxs("button",{className:"selector-button "+(e===X?"active":""),onClick:()=>s(X),children:[t.jsx("div",{className:"icon grenadier",children:""}),t.jsx("div",{children:"Grenadier"})]}),t.jsxs("button",{className:"selector-button "+(e===q?"active":""),onClick:()=>s(q),children:[t.jsx("div",{className:"icon kamikaze",children:""}),t.jsx("div",{children:"Kamikaze"})]}),t.jsxs("button",{className:"selector-button "+(e===Z?"active":""),onClick:()=>s(Z),children:[t.jsx("div",{className:"icon bomber",children:""}),t.jsx("div",{children:"Bomber"})]})]})]})}const Vt=({selectedVehicleId:e})=>{const[s,o]=r.useState(null),i=se((e=>e.getVehicleHealth));if(r.useEffect((()=>{if(!e)return void o(null);s();const t=setInterval(s,500);return()=>clearInterval(t);function s(){const t=i(e);o(t)}}),[e,i]),!s)return null;const n=Math.floor(s.currentHealth/s.maxHealth*100);return t.jsxs("div",{className:"vehicle-health-hud",children:[t.jsxs("h3",{children:["Vehicle Status: ",s.type.replace(/_/g," ").toUpperCase()]}),t.jsxs("div",{className:"health-bar-container",children:[t.jsxs("div",{className:"health-bar-label",children:["Health: ",n,"%"]}),t.jsx("div",{className:"health-bar-outer",children:t.jsx("div",{className:"health-bar-inner",style:{width:`${n}%`,backgroundColor:n>70?"#44ff44":n>40?"#ffff44":n>20?"#ff8844":"#ff4444"}})}),t.jsxs("div",{className:"health-status",children:["Status: ",s.isDead?"DESTROYED":s.isCritical?"CRITICAL":n<60?"DAMAGED":"OPERATIONAL"]})]}),s.mobilityFactor<1&&t.jsxs("div",{className:"mobility-info",children:["Mobility: ",Math.floor(100*s.mobilityFactor),"%"]}),s.visualEffects.length>0&&t.jsxs("div",{className:"damage-effects",children:["Active Effects: ",s.visualEffects.join(", ")]}),s.damageLog.length>0&&t.jsxs("div",{className:"damage-log",children:[t.jsx("h4",{children:"Recent Damage:"}),t.jsx("ul",{children:s.damageLog.slice(-3).map(((e,s)=>t.jsxs("li",{children:[e.weaponType?de(e.weaponType):"Unknown"," -",Math.floor(e.finalDamage)," damage",e.hitLocation&&` (${e.hitLocation})`]},s)))})]})]})},Bt=[{value:"body",label:"Body"},{value:"turret",label:"Turret"},{value:"tracks",label:"Tracks/Wheels"},{value:"rear",label:"Rear"},{value:"front",label:"Front"},{value:"cabin",label:"Cabin"},{value:"engine",label:"Engine"},{value:"cargo",label:"Cargo"}],Ut=({vehicle:e,respawnInfo:s})=>{if(!e)return null;const o=e.currentHealth/e.maxHealth*100,r=e.isDead?"red":e.isCritical?"orange":"green",i=e.isDestroyed?"DESTROYED":e.isDead?"DEAD":e.isCritical?"CRITICAL":"OPERATIONAL";return t.jsxs("div",{className:"vehicle-status",children:[t.jsx("h4",{children:"Vehicle Status"}),t.jsx("div",{className:"health-bar",children:t.jsx("div",{className:"health-bar-fill",style:{width:`${o}%`,backgroundColor:r}})}),t.jsxs("p",{children:["Health: ",Math.round(e.currentHealth)," / ",e.maxHealth]}),t.jsxs("p",{children:["Status: ",i]}),t.jsxs("p",{children:["Mobility: ",Math.round(100*e.mobilityFactor),"%"]}),s&&t.jsx("div",{className:"respawn-timer",children:s.disappeared?t.jsxs("p",{children:["Respawning in: ",Math.ceil(s.timeLeft/1e3),"s"]}):t.jsxs("p",{children:["Disappearing in: ",Math.ceil(s.timeLeft/1e3),"s"]})}),t.jsx("div",{className:"effect-tags",children:e.visualEffects.map(((e,s)=>t.jsx("span",{className:"effect-tag",children:e},s)))})]})},Kt=({respawnStatus:e,vehicleHealth:s})=>0===Object.keys(e).length?t.jsx("p",{children:"No vehicles in respawn queue"}):t.jsx("ul",{children:Object.entries(e).map((([e,o])=>{const r=s[e];return r?t.jsxs("li",{children:[r.type," - ",e.substring(0,8),":",o.disappeared?t.jsxs("span",{children:[" Respawning in ",Math.ceil(o.timeLeft/1e3),"s"]}):t.jsxs("span",{children:[" Disappearing in ",Math.ceil(o.timeLeft/1e3),"s"]})]},e):null}))}),Yt=k.memo((()=>{const[e,s]=r.useState(""),[o,i]=r.useState(ie.RPG),[n,a]=r.useState(10),[c,l]=r.useState("body"),[d,h]=r.useState({}),u=r.useRef(null),{vehicleHealth:m,applyDamage:p,repairVehicle:x}=se(),f=r.useMemo((()=>Object.values(m)),[m]),y=r.useMemo((()=>m[e]),[m,e]);r.useEffect((()=>{f.length>0&&!e&&s(f[0].id)}),[f,e]);const g=r.useCallback((()=>{e&&p(e,n,c,o)}),[e,n,c,o,p]),j=r.useCallback((()=>{e&&x(e)}),[e,x]),M=r.useCallback((()=>{h((e=>{const t={...e};let s=!1;return Object.keys(t).forEach((e=>{const o=t[e],r=Date.now(),i=Math.floor(o.timeLeft/1e3);if(o.disappeared){const n=o.respawnAt-r,a=Math.floor(n/1e3);n<=0?(delete t[e],s=!0):a!==i&&(t[e]={...o,timeLeft:n},s=!0)}else{const n=o.disappearAt-r,a=Math.floor(n/1e3);n<=0?(t[e]={disappeared:!0,respawnAt:o.respawnAt,timeLeft:o.respawnAt-r},s=!0):a!==i&&(t[e]={...o,timeLeft:n},s=!0)}})),s?t:e}))}),[]);r.useEffect((()=>((()=>{const e={};let t=!1;f.forEach((s=>{if(s.isDead||s.isDestroyed){const o=d[s.id],r=Date.now();if(o)e[s.id]=o;else if(t=!0,s.isDead&&!s.isDestroyed)e[s.id]={disappearAt:r+5e3,respawnAt:r+35e3,timeLeft:5e3};else if(s.isDestroyed){const t=r+3e4;e[s.id]={disappeared:!0,respawnAt:t,timeLeft:t-r}}}})),(t||Object.keys(d).some((t=>!e[t])))&&h((t=>{const s={};return Object.keys(e).forEach((o=>{s[o]=e[o]||t[o]})),s}))})(),u.current=setInterval(M,1e3),()=>{u.current&&(clearInterval(u.current),u.current=null)})),[f,M]);return t.jsxs("div",{className:"vehicle-damage-controls",children:[t.jsx("h3",{children:"Vehicle Damage Controls"}),t.jsx("div",{className:"control-group",children:t.jsxs("label",{children:["Vehicle:",t.jsx("select",{value:e,onChange:e=>s(e.target.value),children:f.map((e=>t.jsxs("option",{value:e.id,children:[e.type," - ",e.id.substring(0,8),e.isDead?" (DEAD)":"",e.isDestroyed?" (DESTROYED)":""]},e.id)))})]})}),t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"control-group",children:t.jsxs("label",{children:["Damage Amount:",t.jsx("input",{type:"range",min:"1",max:"50",value:n,onChange:e=>a(parseInt(e.target.value))}),t.jsx("span",{children:n})]})}),t.jsx("div",{className:"control-group",children:t.jsxs("label",{children:["Weapon Type:",t.jsx("select",{value:o,onChange:e=>i(e.target.value),children:Object.values(ie).map((e=>t.jsx("option",{value:e,children:e.replace(/_/g," ")},e)))})]})}),t.jsx("div",{className:"control-group",children:t.jsxs("label",{children:["Hit Location:",t.jsx("select",{value:c,onChange:e=>l(e.target.value),children:Bt.map((({value:e,label:s})=>t.jsx("option",{value:e,children:s},e)))})]})})]}),y&&t.jsx(Ut,{vehicle:y,respawnInfo:d[e]}),t.jsxs("div",{className:"button-group",children:[t.jsx("button",{onClick:g,disabled:!e||(null==y?void 0:y.isDestroyed),className:"damage-button",children:"Apply Damage"}),t.jsx("button",{onClick:j,disabled:!e||(null==y?void 0:y.isDestroyed)||(null==y?void 0:y.currentHealth)===(null==y?void 0:y.maxHealth),className:"repair-button",children:"Repair"})]}),t.jsxs("div",{className:"respawn-list",children:[t.jsx("h4",{children:"Respawn Timers"}),t.jsx(Kt,{respawnStatus:d,vehicleHealth:m})]})]})}));function Xt(){const[e,s]=r.useState(null),i={shadows:!0,camera:{position:[0,20,100],fov:50},dpr:[1,2],onPointerMissed:()=>s(null)};return t.jsx("div",{style:{width:"100%",height:"100vh"},children:t.jsx(Q,{children:t.jsxs(Ht,{children:[t.jsxs(o,{...i,children:[t.jsx("color",{attach:"background",args:["#87CEEB"]}),t.jsx("fog",{attach:"fog",args:["#87CEEB",100,1e3]}),t.jsx(r.Suspense,{fallback:null,children:t.jsx(Tt,{onSelectVehicle:s})}),!1]}),t.jsxs("div",{className:"ui-layer",children:[t.jsx($t,{}),t.jsx(Vt,{selectedVehicleId:e}),t.jsx(Yt,{selectedVehicleId:e,onSelectVehicle:s})]})]})})})}P.createRoot(document.getElementById("root")).render(t.jsx(k.StrictMode,{children:t.jsx(Q,{children:t.jsx(Xt,{})})}));
